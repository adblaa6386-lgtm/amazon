<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Amezon</title>

    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">

    <!-- IOS FULL SCREEN & STATUS BAR CONFIGURATION -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Amezon">
    <link rel="apple-touch-icon" href="9w.png">

    <style>
        /* --- Global & Page Styles --- */
        :root {
            --primary-blue: #007bff;
            --light-grey: #f0f2f2;
            --medium-grey: #ccc;
            --text-color: #0F1111;
            --success-green: #28a745;
            --danger-red: #dc3545;
            --dark-grey: #343a40;
            --light-blue: #e6f3ff;
            --amazon-green: #3E8277;
            --amazon-teal: #007185;
            --border-light: #e7e7e7; 
            --border-dark: #d5d9d9;
        }
        
        * {
            -webkit-tap-highlight-color: transparent; 
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
            margin: 0; padding: 0;
        }
        input, textarea, select {
            -webkit-user-select: auto;
            user-select: auto;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Amazon Ember", Arial, sans-serif;
            background-color: #ffffff;
            color: #0F1111;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            overscroll-behavior-y: none;
            
            /* FIXED: Removed Safe Area padding so content/background fills screen fully */
            min-height: 100vh;
        }

        a { text-decoration: none; color: inherit; }

        /* --- TOUCH FEEDBACK --- */
        button:active, .amz-btn:active, .list-button:active, .admin-button:active, .pill-button:active, .account-button:active, .os-amz-action-btn:active {
            opacity: 0.6;
            background-color: #d5d9d9 !important;
            transition: background-color 0.1s, opacity 0.1s;
        }

        /* --- WATERMARK STYLES --- */
        #watermark-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 2147483647;
            pointer-events: none;
            overflow: hidden; 
            display: none; 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            grid-auto-rows: 100px;
            gap: 10px;
            padding: 10px;
            mix-blend-mode: multiply; 
        }

        .watermark-cell {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .watermark-text {
            font-size: 15px;
            font-weight: 900;
            color: #000;
            text-transform: uppercase;
            opacity: 0.12; 
            user-select: none;
            white-space: nowrap;
            text-align: center;
            transform: rotate(-15deg);
        }

        @keyframes float-1 { 0% { transform: translate(0, 0) rotate(-15deg); } 25% { transform: translate(15px, -10px) rotate(-15deg); } 50% { transform: translate(-5px, 15px) rotate(-15deg); } 75% { transform: translate(-15px, -5px) rotate(-15deg); } 100% { transform: translate(0, 0) rotate(-15deg); } }
        @keyframes float-2 { 0% { transform: translate(0, 0) rotate(-15deg); } 30% { transform: translate(-15px, 10px) rotate(-15deg); } 60% { transform: translate(10px, -15px) rotate(-15deg); } 100% { transform: translate(0, 0) rotate(-15deg); } }
        @keyframes float-3 { 0% { transform: translate(0, 0) rotate(-15deg); } 40% { transform: translate(10px, 10px) rotate(-15deg); } 80% { transform: translate(-10px, -10px) rotate(-15deg); } 100% { transform: translate(0, 0) rotate(-15deg); } }
        @keyframes float-4 { 0% { transform: translate(0, 0) rotate(-15deg); } 50% { transform: translate(0, 20px) rotate(-15deg); } 100% { transform: translate(0, 0) rotate(-15deg); } }
        @keyframes float-5 { 0% { transform: translate(0, 0) rotate(-15deg); } 50% { transform: translate(20px, 0) rotate(-15deg); } 100% { transform: translate(0, 0) rotate(-15deg); } }

        .move-type-1 { animation: float-1 8s ease-in-out infinite; }
        .move-type-2 { animation: float-2 10s ease-in-out infinite; }
        .move-type-3 { animation: float-3 12s ease-in-out infinite; }
        .move-type-4 { animation: float-4 9s ease-in-out infinite; }
        .move-type-5 { animation: float-5 11s ease-in-out infinite; }

        /* --- INSTANT PAGE SWITCHING --- */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }
        
        #home-page {
             background-color: var(--light-grey);
        }
        
        /* --- IMAGE PAGE STYLES --- */
        #image-page .content {
            display: block;
            background-color: #fff;
            padding: 0;
            min-height: 100vh;
        }
        
        #image-page img {
            width: 100%;
            height: auto;
            display: block;
            max-height: none;
        }

        /* --- Loader Styles --- */
        #progress-bar-loader {
            position: fixed; left: 0; width: 100%; height: 4px;
            background-color: transparent; z-index: 9998;
            opacity: 0; visibility: hidden;
            transition: opacity 0.1s ease;
            overflow: hidden;
        }
        #progress-bar-loader.visible {
            opacity: 1; visibility: visible;
        }
        #progress-bar-loader::before {
            content: ''; display: block; height: 100%; width: 100%;
            background-image: linear-gradient(to right, #FFA41C, #FFD814, #FFA41C);
            background-size: 200% auto;
            animation: progressBarFlow 1s linear infinite;
        }
        @keyframes progressBarFlow {
            0% { background-position: 0% 0; }
            100% { background-position: -100% 0; }
        }

        /* --- INVOICE LOADER --- */
        #invoice-loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 11000;
            display: none;
            justify-content: center; align-items: center;
            background-color: transparent; 
            pointer-events: all; 
        }
        
        .invoice-box {
            width: 100px;
            height: 100px;
            background-color: rgba(0, 0, 0, 0.75); 
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .invoice-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3); 
            border-top: 3px solid #ffffff; 
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 0.8s linear infinite;
        }

        /* --- SKELETON LOADING --- */
        .skeleton {
            background: #e1e4e8;
            position: relative;
            overflow: hidden;
        }
        .skeleton::after {
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0,
                rgba(255, 255, 255, 0.4) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 1.5s infinite;
            content: '';
        }
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
        
        /* Specific Skeleton Shapes */
        .skeleton-card {
            flex: 0 0 140px; width: 140px; height: 140px;
            border-radius: 8px; margin-right: 10px;
            background-color: #fff; border: 1px solid #eee; display: inline-block;
        }
        
        .skeleton-rect {
            flex: 0 0 180px; width: 180px; height: 120px;
            border-radius: 8px; margin-right: 10px;
            background-color: #fff; border: 1px solid #eee; display: inline-block;
        }
        
        .skeleton-square-small {
            flex: 0 0 calc((100vw - 45px) / 3.2); width: calc((100vw - 45px) / 3.2); height: auto; aspect-ratio: 1/1;
            border-radius: 8px; margin-right: 8px;
            background-color: #fff; border: 1px solid #eee; display: inline-block;
        }

        .skeleton-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%;
        }
        .skeleton-grid-item {
            width: 100%; aspect-ratio: 1/1; border-radius: 8px;
            background-color: #fff; border: 1px solid #eee;
        }

        .skeleton-inner {
            width: 80%; height: 80%;
            background-color: #f0f0f0;
            margin: 10% auto;
            border-radius: 4px;
        }

        /* Header and Footer */
        .fixed-header, .fixed-footer {
            position: fixed; left: 0; right: 0; width: 100%; 
            z-index: 2002; 
        }
        .fixed-header { 
            top: 0; 
            background-color: #ffffff;
            /* FIXED: Removed padding-top env so header sits BEHIND status bar */
            padding-top: 0; 
        }
        .fixed-footer { 
            bottom: 0; 
            cursor: pointer; 
            z-index: 1000;
            /* FIXED: Removed padding-bottom env so footer sits BEHIND home bar */
            padding-bottom: 0;
        }
        
        .fixed-header img, .fixed-footer img, img.full-width-image, .full-width-image img {
            width: 100%; height: auto; display: block;
        }
        
        img {
            display: block; 
            -webkit-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            backface-visibility: hidden;
        }
        
        .full-width-image.no-gap { margin-top: -1px; }

        #back-tap-area {
            position: absolute; top: 0; left: 0; width: 15%; height: 100%; 
            z-index: 3000; 
            cursor: pointer;
            background-color: rgba(255, 0, 0, 0); 
        }
        
        /* Footer Grid Overlay */
        .footer-grid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: grid; grid-template-columns: repeat(6, 1fr);
            z-index: 2005;
        }
        .footer-zone {
            background: transparent;
        }
        
        /* --- Home Page Modules --- */
        #home-page .module {
            background-color: #fff; padding: 15px; margin-bottom: 10px;
        }
        #home-page .module-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
        }
        #home-page .module-title { font-weight: bold; font-size: 18px; }
        
        .see-all, .edit-button {
            text-decoration: none; color: var(--amazon-teal); font-size: 14px;
            background: none; border: none; cursor: pointer; padding: 0;
        }
        .edit-button { margin-right: 5px; }

        .quick-access {
            background-color: #fff; overflow-x: auto; white-space: nowrap;
            padding: 15px; border-bottom: 1px solid #ddd;
        }
        .quick-access-inner { display: inline-block; }
        .pill-button {
            background-color: #fff; border: 1px solid var(--medium-grey); border-radius: 50px;
            padding: 10px 20px; margin-right: 10px; font-size: 14px; cursor: pointer;
        }

        .card-row { display: flex; overflow-x: auto; padding-bottom: 15px; }
        .card-row::-webkit-scrollbar { display: none; }
        
        /* GENERIC CARD */
        .card {
            flex: 0 0 140px; width: 140px; height: 140px;
            background-color: #fff; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-right: 10px; display: flex; align-items: center;
            justify-content: center; padding: 10px; box-sizing: border-box;
            text-decoration: none; color: inherit;
        }
        .card img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .placeholder-text { color: #666; font-size: 14px; padding-left: 5px; }

        /* --- YOUR ORDERS HOME CARD STYLE (Light Border) --- */
        .your-orders-card {
            flex: 0 0 180px; 
            height: 120px; 
            background-color: #fff; 
            border: 1px solid var(--border-light); 
            border-radius: 8px;
            margin-right: 10px; 
            display: flex; 
            align-items: center;
            justify-content: center; 
            padding: 10px; 
            box-sizing: border-box;
            text-decoration: none; 
            color: inherit;
        }
        .your-orders-card img {
            max-width: 90%; 
            max-height: 90%; 
            object-fit: contain;
        }

        /* --- BUY AGAIN HOME CARD STYLE (Light Border) --- */
        .buy-again-home-card {
            flex: 0 0 calc((100vw - 45px) / 3.2); 
            aspect-ratio: 1 / 1;
            background-color: #fff;
            border: 1px solid var(--border-light); 
            border-radius: 8px;
            margin-right: 8px;
            display: flex; align-items: center; justify-content: center;
            padding: 5px; box-sizing: border-box;
        }
        .buy-again-home-card img {
            max-width: 95%; max-height: 95%; object-fit: contain;
        }

        /* --- KEEP SHOPPING GRID STYLE (Light Border) --- */
        .keep-shopping-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding-bottom: 10px;
        }
        .keep-shopping-card {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: #fff;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            padding: 8px;
            box-sizing: border-box;
        }
        .keep-shopping-card img {
            max-width: 100%; max-height: 100%; object-fit: contain;
        }
        .keep-shopping-hidden { display: none; }

        #home-page .module-footer { text-align: center; margin-top: 10px; }
        .see-more-link {
            color: #555; text-decoration: none; display: inline-flex;
            align-items: center; font-size: 14px; cursor: pointer;
        }
        .arrow-down { width: 24px; height: 24px; fill: currentColor; }
        
        .list-card {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px; border: 1px solid #ddd; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .list-card-text { display: flex; flex-direction: column; }
        .list-title { font-weight: bold; }
        .list-subtitle { font-size: 12px; color: #555; }
        .list-card-previews { display: flex; gap: 5px; }
        .preview-square {
            width: 40px; height: 40px; background-color: #f0f0f0;
            border-radius: 4px; background-size: cover; background-position: center;
        }
        .extra-items {
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; color: #333;
        }

        .account-buttons { display: flex; gap: 10px; }
        .account-button {
            flex: 1; padding: 15px 10px; font-size: 14px;
            background-color: #fff; border: 1px solid #ddd;
            border-radius: 8px; text-align: center; cursor: pointer;
        }

        .help-module { text-align: center; }
        .help-title { font-size: 18px; margin-bottom: 15px; }
        .help-button {
            width: calc(100% - 20px); padding: 15px; background-color: #fff;
            border: 1px solid #ddd; border-radius: 8px; font-size: 16px;
            cursor: pointer; margin: 0 auto;
        }

        /* --- Orders Page Specific Styles --- */
        #orders-page .admin-panel-link img {
            width: 100%; cursor: pointer; height: auto; display: block;
        }
        #orders-page .module { padding: 16px; }
        #orders-page .module-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
        }
        #orders-page .module-header h2 {
            font-size: 1.2rem; font-weight: bold; margin: 0;
        }
        #orders-page .module-header .see-more {
            font-size: 0.9rem; color: var(--amazon-teal); text-decoration: none; cursor: pointer;
        }

        /* --- UPDATED: BUY AGAIN PAGE STYLES (Wider, Shorter, Lighter, GREY BG) --- */
        .buy-again-grid {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 0 16px 8px 10px;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .buy-again-grid::-webkit-scrollbar {
            display: none;
        }

        .buy-again-card {
            flex: 0 0 170px; 
            height: 95px;    
            background-color: var(--light-grey); 
            border: 1px solid #e7e7e7; 
            border-radius: 8px; 
            display: flex;
            align-items: center; 
            justify-content: center; 
            padding: 8px;
            box-sizing: border-box;
        }

        .buy-again-card img {
            max-width: 90%; 
            max-height: 90%; 
            object-fit: contain;
            mix-blend-mode: multiply; 
            margin: 0;
        }
        
        .buy-again-card p {
            display: none; 
        }

        .separator {
            height: 8px; background-color: #EAEDED; border: none; margin: 0;
        }

        .purchase-history-header h2 {
            font-size: 1.2rem; font-weight: bold; margin: 0 0 4px 0;
        }
        .purchase-history-header p {
            font-size: 0.9rem; color: #565959; margin: 0;
        }

        /* --- UPDATED: PURCHASE ITEM CARD (Reduced Height) --- */
        .purchase-item-card {
            display: flex; border: 1px solid #ddd; border-radius: 8px;
            margin-bottom: 12px; background-color: #fff;
            overflow: hidden; align-items: stretch; 
            height: 85px; 
        }
        .purchase-item-card .item-image {
            flex-basis: 85px; 
            flex-shrink: 0; padding: 5px;
            display: flex; align-items: center; justify-content: center;
            border-right: 1px solid #eee; background-color: #F0F2F2;
        }
        .purchase-item-card .item-image img {
            max-width: 100%; max-height: 100%; object-fit: contain;
        }
        .purchase-item-card .item-info {
            flex-grow: 1; padding: 8px 12px;
            display: flex; flex-direction: column; justify-content: center; overflow: hidden;
        }
        .purchase-item-card .item-info .item-name {
            font-weight: bold; margin: 0 0 4px 0; color: #0F1111;
            cursor: pointer; text-decoration: none; font-size: 15px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .purchase-item-card .item-info .item-status {
            font-size: 0.85rem; color: #565959; margin: 0;
        }

        /* --- Standard Order Details Page Styles --- */
        .product-info-module {
            display: flex; padding: 16px; gap: 16px; align-items: flex-start;
        }
        .product-info-module .product-image {
            width: 150px; height: 150px; object-fit: contain;
        }
        /* UPDATED: Product Details Flex & Truncation */
        .product-info-module .product-details {
            display: flex; flex-direction: column; justify-content: center; height: 150px;
            flex: 1; 
            min-width: 0; /* Important for flex child truncation */
        }
        /* UPDATED: Product Name Styles */
        .product-info-module .product-name {
            color: #0F1111; 
            font-size: 1.0rem; 
            display: block; 
            margin-bottom: 8px; 
            text-decoration: none;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            font-weight: bold;
        }
        .product-info-module .product-details .product-name:hover { text-decoration: none; }
        
        .product-info-module .product-details .share-item {
             display: flex; align-items: center; cursor: pointer;
        }

        .delivery-status-module { padding: 16px; border-top: 1px solid #ddd; }
        .delivery-status {
            display: flex; align-items: center; gap: 12px; margin-bottom: 16px;
        }
        .delivery-status .icon {
            background-color: var(--amazon-teal); color: white; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: bold;
        }
        .delivery-status .text-bold { font-weight: bold; }
        .delivery-feedback { margin-bottom: 16px; }
        .delivery-feedback .feedback-text { font-size: 0.8rem; color: #565959; margin-bottom: 4px; }
        .delivery-feedback .stars { color: #FFA41C; font-size: 1.5rem; }

        .list-button {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px solid #ddd;
            text-decoration: none; color: inherit;
        }
        .list-button .button-text { display: flex; flex-direction: column; }
        .list-button .button-text .sub-text { font-size: 0.8rem; color: #565959; margin-top: 2px; }
        .list-button .arrow { color: #888; }

        .module-with-buttons { padding: 0 16px; }
        .module-with-buttons .list-button:first-of-type { border-top: 1px solid #ddd; }
        .module-with-buttons h3 {
            font-size: 1.2rem; font-weight: bold; margin-top: 16px; margin-bottom: 8px;
        }
        .details-page-footer { padding: 16px; color: #565959; font-size: 0.9rem; }
        
        .details-page-ad-image { 
            width: calc(100% + 32px) !important; 
            margin: 0 -16px; 
            display: block; 
            height: auto; 
        }

        /* --- Track Page Styles --- */
        .track-module { padding: 16px; }
        .track-module-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
        }
        .track-module-header h2 { font-size: 1rem; font-weight: bold; margin: 0; flex-grow: 1; }
        .track-module-header .see-all-orders {
            font-size: 0.9rem; color: var(--amazon-teal); text-decoration: none; white-space: nowrap;
        }
        .thin-separator { border: none; border-top: 1px solid #ddd; margin: 0 -16px; }
        
        .track-module .full-width-image { margin: 0 -16px; width: calc(100% + 32px); display: block; }
        
        .thick-separator { border: none; border-top: 8px solid #EAEDED; margin: 0 -16px 16px -16px; }
        .shipping-address-section h3 { font-size: 1.2rem; margin: 0 0 8px 0; }
        .shipping-address-section p { margin: 0; font-size: 1rem; line-height: 1.4; white-space: pre-wrap; }
        .order-info-section h2 { font-size: 1.2rem; font-weight: bold; margin-bottom: 8px; }
        .thick-separator-light { border: none; border-top: 1px solid #ddd; margin: 0; }
        .order-details-link {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; text-decoration: none; color: inherit; font-size: 1rem;
        }
        .sticky-track-header {
            position: sticky; background-color: #ffffff; z-index: 999; padding-bottom: 0 !important;
        }
        .track-product-image-container { padding: 16px 0; text-align: left; }
        .track-product-image { max-width: 80px; max-height: 80px; object-fit: contain; }
        
        .amz-scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 4px 15px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .amz-scroll-container::-webkit-scrollbar {
            display: none;
        }

        .amz-btn {
            flex: 0 0 auto;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 44px;
            padding: 0 16px;
            background-color: #fafafa; 
            border: 1px solid #d5d9d9;
            border-radius: 8px;
            box-shadow: 0 2px 5px 0 rgba(213,217,217,0.5);
            color: #0f1111;
            text-decoration: none;
            font-size: 13px;
            line-height: 16px;
            font-weight: 400;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.1s ease;
        }

        .shipped-with-info { padding: 0 16px 16px 16px; }
        .shipped-with-info h3 { font-size: 1.2rem; font-weight: bold; margin: 0 0 8px 0; }
        .shipped-with-info p, .shipped-with-info a { font-size: 1rem; margin: 0 0 4px 0; color: var(--amazon-teal); text-decoration: none; }
        
        /* Updates Overlay Styles */
        .updates-overlay-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000; display: none;
        }
        .updates-overlay-container.visible { display: block; }

        .updates-backdrop {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); 
            opacity: 0; transition: opacity 0.3s ease;
        }
        .updates-overlay-container.visible .updates-backdrop { opacity: 1; }

        .updates-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            transform: translateY(100%); transition: transform 0.8s cubic-bezier(0.1, 0.7, 0.1, 1);
            background-color: transparent;
            max-height: 90vh;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }
        .updates-overlay-container.visible .updates-sheet { transform: translateY(0); }

        .updates-sheet img {
            width: 100%; display: block; height: auto;
            margin-bottom: -1px; 
        }

        /* --- Order Summary Page --- */
        #order-summary-page .content { background-color: #ffffff; padding: 0 !important; }
        
        .os-sub-nav-bar {
            background-color: #eaeded;
            padding: 12px 15px;
            border-bottom: 1px solid #d5d9d9;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .os-content-container {
            padding: 15px 15px 40px 15px;
        }

        .os-section-title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 8px;
            margin-top: 20px;
        }
        .os-section-title.first { margin-top: 0; }

        .os-amz-card {
            border: 1px solid #d5d9d9;
            border-radius: 8px;
            background-color: #ffffff;
            margin-bottom: 4px;
        }

        .os-od-padding { padding: 14px 15px; }
        
        .os-od-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            line-height: 20px;
            margin-bottom: 2px;
        }
        
        .os-label-grey { color: #565959; }
        .os-val-black { color: #0f1111; }

        .os-invoice-row {
            border-top: 1px solid #d5d9d9;
            padding: 14px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            border-radius: 0 0 8px 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .os-chevron {
            width: 8px; height: 8px;
            border-right: 2px solid #111;
            border-top: 2px solid #111;
            transform: rotate(45deg);
        }

        .os-arriving-text {
            font-size: 17px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .os-product-flex {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .os-img-box {
            position: relative;
            width: 70px;
            flex-shrink: 0;
        }
        .os-img-box img { width: 100%; height: auto; object-fit: contain; }
        
        .os-qty-circle { display: none !important; }
        
        .os-prod-info { font-size: 14px; line-height: 1.35; }
        .os-prod-name { font-weight: 700; margin-bottom: 4px; display: block; text-decoration: none; color: inherit; }
        .os-sold-line { font-size: 12px; color: #565959; margin-bottom: 4px;}
        .os-blue-link { color: var(--amazon-teal); text-decoration: none; }
        .os-price-text { font-weight: 700; font-size: 14px; }

        .os-button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .os-amz-action-btn {
            flex: 1 0 auto;
            background: #ffffff;
            border: 1px solid #d5d9d9;
            border-radius: 100px;
            height: 38px;
            padding: 0 16px;
            display: flex; align-items: center; justify-content: center;
            text-align: center;
            font-size: 13px; color: #0f1111;
            box-shadow: 0 2px 5px 0 rgba(213,217,217,0.5);
            white-space: nowrap;
            text-decoration: none;
            cursor: pointer;
        }

        .os-info-box {
            padding: 15px;
            font-size: 14px;
            line-height: 20px;
        }
        .os-summary-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .os-grand-total {
            font-weight: 700;
            font-size: 15px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .os-full-width-image {
            width: calc(100% + 30px); 
            margin: 20px -15px 0 -15px;
            display: block;
            height: auto;
        }

        /* --- Admin Panel --- */
        #admin-page .content { padding: 0; background-color: #f8f9fa; }
        .admin-header-main {
            background-color: #fff; padding: 15px 20px; border-bottom: 1px solid #dee2e6;
            display: flex; justify-content: space-between; align-items: center;
        }
        .admin-header-main h1 { margin: 0; font-size: 1.5rem; }
        .admin-header-main a { color: var(--primary-blue); text-decoration: none; }
        .admin-header-actions { display: flex; align-items: center; gap: 15px; }
        
        /* Notification Icon */
        .notification-icon-container { position: relative; cursor: pointer; }
        .notification-icon { font-size: 1.5rem; color: #333; }
        .notification-dot {
            position: absolute; top: -2px; right: -2px; width: 10px; height: 10px;
            background-color: var(--danger-red); border-radius: 50%; display: none;
        }
        
        .admin-section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd;
        }
        .admin-section-header h2 { margin: 0; font-size: 1.25rem; }
        .admin-button {
             background-color: var(--primary-blue); color: white; padding: 10px 15px;
             border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
             text-decoration: none; display: inline-flex; align-items: center; gap: 5px;
             justify-content: center;
        }
        .admin-button.secondary { background-color: var(--success-green); }
        .admin-button:hover { opacity: 0.9; }

        .item-list-admin { list-style: none; padding: 0; display: grid; gap: 15px; }
        .item-list-admin-card {
            background-color: #fff; border: 1px solid #ddd; border-radius: 8px;
            padding: 15px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative;
        }
        /* Drag and Drop Styles */
        .item-list-admin-card.dragging { opacity: 0.5; background-color: var(--light-blue); }
        .item-list-admin-card.drag-over-top::before, .item-list-admin-card.drag-over-bottom::after {
            content: ''; position: absolute; left: 0; right: 0; height: 4px;
            background-color: var(--primary-blue);
        }
        .item-list-admin-card.drag-over-top::before { top: -2px; }
        .item-list-admin-card.drag-over-bottom::after { bottom: -2px; }
        
        .item-list-admin-card .item-preview {
            width: 50px; height: 50px; flex-shrink: 0; background-color: #eee; border-radius: 4px;
            background-size: contain; background-position: center; background-repeat: no-repeat; cursor: grab;
        }
        .item-list-admin-card:active { cursor: grabbing; }
        
        .item-list-admin-card .item-info-admin { flex-grow: 1; }
        .item-list-admin-card .item-info-admin p { margin: 0; font-weight: 600; }
        .item-list-admin-card .item-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .item-list-admin-card .item-actions button {
            padding: 8px 10px; border-radius: 5px; border: none; cursor: pointer; font-size: 0.8rem; color: #fff;
        }
        .admin-edit-btn { background-color: var(--primary-blue); }
        .admin-delete-btn { background-color: var(--danger-red); }
        .admin-duplicate-btn { background-color: var(--success-green); }
        
        /* New Admin Control Panel Styles */
        .admin-controls { padding: 20px; background-color: white; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .admin-user-info { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; }
        .admin-main-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; }
        
        .glow-button {
            background-color: red;
            box-shadow: 0 0 10px red;
            animation: glowing 1.5s infinite;
        }
        @keyframes glowing {
            0% { box-shadow: 0 0 5px red; }
            50% { box-shadow: 0 0 20px red; }
            100% { box-shadow: 0 0 5px red; }
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%;
            width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Alert & Confirm Modal Styles */
        .custom-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 20000 !important; 
            display: none;
            justify-content: center; align-items: center;
        }
        .custom-box {
            background: #fff; width: 85%; max-width: 350px; padding: 20px;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center; font-family: "Amazon Ember", Arial, sans-serif;
        }
        .custom-box p { margin: 0 0 20px 0; font-size: 16px; color: #333; }
        .custom-box h3 { margin-top: 0; }
        .custom-box input { margin-bottom: 15px; width: 100%; }
        
        .custom-box button {
            padding: 10px 20px; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; font-size: 14px;
        }
        #custom-msg-close { background: var(--primary-blue); color: white; width: 100%; }
        
        /* API Modal below Alert */
        #api-run-modal { z-index: 5000; }
        
        #wallet-key-modal { z-index: 10001; }

        /* Admin Modal Styles */
        .admin-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; justify-content: center; align-items: flex-end; 
            opacity: 0; transition: opacity 0.3s ease;
        }
        .admin-modal-overlay.visible { display: flex; opacity: 1; }
        
        .admin-modal {
            background: #f8f9fa; width: 100%; max-width: 600px; border-radius: 12px 12px 0 0;
            height: 90vh; max-height: 90dvh; 
            display: flex; flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); transform: translateY(100%); transition: transform 0.3s ease;
        }
        @media (min-width: 600px) {
             .admin-modal-overlay { align-items: center; }
             .admin-modal { border-radius: 12px; height: 85vh; transform: scale(0.95); }
             .admin-modal-overlay.visible .admin-modal { transform: scale(1); }
        }
        @media (max-width: 599px) {
             .admin-modal-overlay.visible .admin-modal { transform: translateY(0); }
        }

        .modal-header {
            padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .modal-header h2 { margin: 0; font-size: 1.2rem; }
        .modal-close-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #888; }
        
        .modal-body { 
            overflow-y: auto; 
            padding: 20px; 
            flex-grow: 1; 
        }
        
        .modal-footer {
            padding: 15px 20px; border-top: 1px solid #eee; background: #fff; 
            display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; align-items: center;
            flex-shrink: 0; 
        }
        
        .form-section-accordion { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #fff; }
        .form-section-accordion summary {
            padding: 15px; font-weight: 600; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center;
        }
        .form-section-accordion summary::-webkit-details-marker { display: none; }
        .form-section-accordion summary:after { content: '▼'; font-size: 0.8em; }
        .form-section-accordion[open] summary:after { content: '▲'; }
        .form-section-accordion-content { padding: 0 15px 15px 15px; }
        
        .form-input-group { margin-bottom: 15px; }
        .form-input-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .form-input-group input, .form-input-group select, .form-input-group textarea {
            width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit; font-size: 1rem;
        }
        /* Disabled Input Styling */
        .form-input-group input:disabled, 
        .form-input-group select:disabled,
        .form-input-group textarea:disabled {
            background-color: #e9ecef; cursor: not-allowed; color: #6c757d; border-color: #d6d8db;
        }
        
        .wallet-wrapper {
            position: relative;
            display: inline-block;
            margin-right: 15px;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            cursor: pointer;
        }
        #wallet-btn {
            font-size: 1.5rem; 
        }
        
        /* --- REDESIGNED LOGIN OVERLAY --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 3000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }

        .login-new-user-bg {
            background: linear-gradient(135deg, #000000, #1a0b2e, #001f3f);
            color: white;
            width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        
        .login-warning {
            color: #ff3333; font-size: 2rem; font-weight: 900; 
            margin-bottom: 10px; letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        .login-note {
            text-align: center; color: #e6f3ff; font-size: 0.9rem; margin-bottom: 30px;
            max-width: 300px; line-height: 1.4;
        }
        
        .login-anim-text {
            font-size: 1.5rem; font-weight: bold;
            background: linear-gradient(90deg, #007bff, #b19cd9, #87ceeb);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 15px;
            animation: textFlow 3s infinite linear;
        }
        @keyframes textFlow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .social-icons {
            display: flex; gap: 20px; margin-bottom: 30px;
        }
        .social-icon svg {
            width: 32px; height: 32px; fill: #87ceeb;
            filter: drop-shadow(0 0 5px #007bff);
        }

        .input-group-login {
            width: 100%; max-width: 300px; margin-bottom: 15px; position: relative;
        }
        .input-group-login input {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.1);
            border: 1px solid #007bff; color: white; border-radius: 8px;
            outline: none; transition: box-shadow 0.3s;
        }
        .input-group-login input::placeholder { color: #aaa; }
        .input-group-login input:focus { box-shadow: 0 0 15px rgba(0, 123, 255, 0.5); }
        
        .pass-group { display: flex; align-items: center; }
        .eye-icon {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            cursor: pointer; font-size: 1.2rem;
        }

        .login-btn-anim {
            width: 100%; max-width: 300px; padding: 12px;
            background: linear-gradient(90deg, #007bff, #6610f2);
            border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 1rem;
            cursor: pointer; position: relative; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,123,255,0.4);
        }
        .login-btn-anim:active { transform: scale(0.98); }
        
        .loader-real {
            width: 50px; height: 50px;
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #ffd700;
            animation: spin 1s ease-in-out infinite;
        }

        
        /* --- Old Admin Panel Overlay Styles (For Home Page) --- */
        .admin-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 100;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .admin-overlay.visible { display: flex; opacity: 1; }
        .admin-overlay .admin-container {
            width: 90%; max-width: 700px; background-color: #fff;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; overflow: hidden; height: 90vh; max-height: 800px; padding: 0;
        }
        .admin-overlay .admin-header { padding: 20px; border-bottom: 1px solid #eee; }
        .admin-overlay .admin-header h1 { margin: 0 0 5px 0; font-size: 22px; text-align: left;}
        .admin-overlay .admin-header p { margin: 0; color: #666; }
        .admin-overlay .admin-tabs { display: flex; border-bottom: 1px solid #eee; }
        .admin-overlay .admin-tab {
            flex: 1; padding: 15px 10px; text-align: center; cursor: pointer;
            background-color: #f8f9fa; color: #6c757d; border-bottom: 3px solid transparent;
            transition: background-color 0.2s, border-color 0.2s; white-space: nowrap;
        }
        .admin-overlay .admin-tab.active { background-color: #fff; border-bottom-color: var(--primary-blue); color: #000; }
        .admin-overlay .admin-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .admin-overlay .admin-tab-content { display: none; }
        .admin-overlay .admin-tab-content.active { display: block; }
        .admin-note { color: #555; font-size: 14px; margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .url-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .url-preview {
            width: 50px; height: 50px; flex-shrink: 0; background-color: #eee;
            border-radius: 6px; background-size: cover; background-position: center;
        }
        .url-input {
            flex-grow: 1; padding: 12px; border: 1px solid var(--medium-grey); border-radius: 4px; font-size: 14px;
        }
        .remove-url-btn {
            background: #e6e6e6; border: none; color: #555; font-weight: bold; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; flex-shrink: 0;
        }
        .remove-url-btn:hover { background-color: var(--danger-red); color: white; }
        .add-url-btn {
            display: block; width: 100%; padding: 12px; background-color: #f8f9fa;
            border: 1px dashed var(--medium-grey); border-radius: 4px; cursor: pointer; margin-top: 15px;
        }
        .admin-footer {
            padding: 15px 20px; border-top: 1px solid #eee; background-color: #fff; display: flex; gap: 10px;
        }
        .admin-button-overlay {
            flex: 1; padding: 12px; border: none; border-radius: 6px;
            font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; text-decoration: none;
        }
        .admin-button-overlay.primary { background-color: var(--primary-blue); color: white; }
        .admin-button-overlay.secondary { background-color: #6c757d; color: white; }
        .save-feedback {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
            background-color: var(--success-green); color: white; padding: 10px 20px;
            border-radius: 6px; opacity: 0; transition: all 0.4s ease; z-index: 101;
        }

        /* --- INVOICE PAGE STYLES --- */
        .invoice-card {
            width: 900px;
            min-width: 900px;
            background-color: #ffffff;
            margin: 20px auto;
            border: 1px solid #d5d9d9;
            padding: 18px 20px;
            box-sizing: border-box;
            font-family: "Arial", sans-serif;
            color: #333333;
        }
        .invoice-card h2, .invoice-card p, .invoice-card h5 {
            margin-top: 0; margin-bottom: 0;
        }
        .invoice-header { margin-bottom: 10px; }
        .invoice-header h2 { text-align: left; margin-bottom: 10px; }
        .invoice-meta-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 14px; }
        .invoice-divider { border: 0; border-top: 1px solid #e7e7e7; margin: 10px 0; }
        .invoice-grid { display: grid; grid-template-columns: 1fr 1fr 0.8fr; gap: 20px; font-size: 13px; margin-bottom: 20px; }
        .invoice-col-label { font-weight: bold; font-size: 13px; margin-bottom: 5px; display: block; }
        .invoice-summary-table { width: 100%; border-collapse: collapse; }
        .invoice-summary-table td { padding: 2px 0; }
        .invoice-summary-table .price-col { text-align: right; }
        .invoice-product-section { border-top: 1px solid #e7e7e7; padding-top: 10px; }
        .invoice-arrival-text { color: #007600; font-weight: bold; font-size: 17px; margin-bottom: 10px; display: block; }
        .invoice-product-row { display: flex; align-items: flex-start; }
        .invoice-img-container { position: relative; margin-right: 15px; }
        .invoice-img-container img { width: 80px; height: 80px; object-fit: contain; }
        .invoice-badge { display: none !important; }
        .invoice-product-details { display: flex; flex-direction: column; }
        .invoice-product-link { color: var(--amazon-teal); text-decoration: none; font-size: 13px; font-weight: bold; margin-bottom: 2px; }
        .invoice-product-link:hover { text-decoration: underline; }
        .invoice-seller-text { color: #565959; font-size: 11px; margin-bottom: 2px; }
        .invoice-price-text { color: #B12704; font-weight: bold; font-size: 13px; }
        
        /* --- TOGGLE SWITCH STYLES --- */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input { display:none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        /* Get Link Button */
        .get-link-btn {
            display: block; width: 100%; text-align: center;
            background-color: var(--danger-red); color: white;
            padding: 8px; margin-top: 5px; border-radius: 4px;
            text-decoration: none; font-size: 0.9rem;
        }
        
        /* Full Screen Countdown Overlay */
        #countdown-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 20005;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        #countdown-text { font-size: 2rem; font-weight: bold; color: var(--primary-blue); }
        #countdown-num { font-size: 4rem; font-weight: bold; color: #333; margin-top: 10px; }

        /* --- THEME MANAGER STYLES --- */
        #theme-manager-modal .modal-body {
            padding: 15px;
        }
        .theme-list {
            display: flex; flex-direction: column; gap: 10px;
        }
        .theme-card {
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            padding: 12px; display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: background 0.2s;
        }
        .theme-card:hover { background: #f0f2f2; }
        .theme-card.active { border-color: var(--primary-blue); background: var(--light-blue); }
        .theme-info { display: flex; align-items: center; gap: 10px; }
        .theme-preview-color {
            width: 30px; height: 30px; border-radius: 50%; background: #ccc; flex-shrink: 0;
            background-size: cover; background-position: center;
        }
        .add-theme-form {
            background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd;
            margin-bottom: 15px; display: none;
        }
        .add-theme-form.visible { display: block; }
        .theme-add-btn-round {
            width: 35px; height: 35px; border-radius: 50%; background: var(--primary-blue); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; border: none; cursor: pointer;
        }

    </style>
</head>
<body>

<div id="progress-bar-loader"></div>

<!-- Watermark Overlay (GRID PROTECTED) -->
<div id="watermark-overlay"></div>

<!-- Countdown Overlay -->
<div id="countdown-overlay">
    <div id="countdown-text">Placing Order...</div>
    <div id="countdown-num"></div>
</div>

<!-- Invoice Loader Overlay -->
<div id="invoice-loader-overlay">
    <div class="invoice-box">
        <div class="invoice-spinner"></div>
    </div>
</div>

<!-- Custom In-App Alert Box -->
<div id="custom-msg-overlay" class="custom-overlay">
    <div class="custom-box">
        <p id="custom-msg-text"></p>
        <button id="custom-msg-close">OK</button>
    </div>
</div>

<!-- Custom Confirmation Box -->
<div id="custom-confirm-overlay" class="custom-overlay">
    <div class="custom-box">
        <p>Are you sure you want to delete this item?</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button id="confirm-yes" class="admin-button" style="background:var(--danger-red);">Yes</button>
            <button id="confirm-no" class="admin-button secondary">No</button>
        </div>
    </div>
</div>

<!-- API Run Modal -->
<div id="api-run-modal" class="custom-overlay">
    <div class="custom-box">
        <h3>Verify Order</h3>
        <input type="text" id="api-order-input" placeholder="Enter existing Order #">
        <div style="display:flex; gap:10px; justify-content:center;">
            <button id="api-pay-btn" class="admin-button secondary">Pay 500Rs</button>
            <button id="api-close-btn" class="admin-button" style="background:#6c757d;">Cancel</button>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div id="notification-modal" class="custom-overlay">
    <div class="custom-box">
        <h3>Notification</h3>
        <p id="notification-text" style="white-space: pre-wrap; text-align:left;"></p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button id="notif-read-btn" class="admin-button secondary">Read</button>
            <button id="notif-reply-btn" class="admin-button">Send Message</button>
            <button id="notif-close-btn" class="admin-button" style="background:#6c757d;">Close</button>
        </div>
    </div>
</div>

<!-- Wallet Key Modal (Replaces Prompt) -->
<div id="wallet-key-modal" class="custom-overlay">
    <div class="custom-box">
        <h3>Security Verification</h3>
        <input type="password" id="wallet-key-input" placeholder="Enter Security Key">
        <div style="text-align:left; margin: 10px 0; font-size: 14px;">
            <input type="checkbox" id="wallet-remember-me" style="width: auto; margin-right: 5px;"> 
            <label for="wallet-remember-me">Remember Me</label>
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button id="wallet-verify-btn" class="admin-button secondary">Verify</button>
            <button id="wallet-cancel-btn" class="admin-button" style="background:#6c757d;">Cancel</button>
        </div>
    </div>
</div>

<!-- Redesigned Login Overlay -->
<div id="login-overlay">
    
    <!-- STATE 1: NEW USER -->
    <div id="login-state-new" class="login-new-user-bg" style="display:none;">
        <div class="login-warning">WARNING</div>
        <div class="login-note">
            This is fake Amazon to prank your friends , if you are using this illegally that's your responsibility .
        </div>
        <div class="login-anim-text">@Dark_Amazon_bot</div>
        
        <div class="social-icons">
            <div class="social-icon">
                <svg viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.16.16-.295.293-.605.293l.213-3.053 5.56-5.022c.242-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/></svg>
            </div>
        </div>

        <div class="input-group-login">
            <input type="text" id="login-id" placeholder="User ID">
        </div>
        
        <div class="input-group-login pass-group">
            <input type="password" id="login-pass" placeholder="Password">
            <span id="toggle-pass" class="eye-icon">👁️</span>
        </div>
        
        <button id="login-btn" class="login-btn-anim">Log In</button>
        <p id="login-msg" style="color: #ff3333; margin-top: 10px;"></p>
    </div>
</div>

<!-- Fixed Header - Visible on all pages -->
<header class="fixed-header">
    <div id="back-tap-area"></div>
    <a href="#home">
        <img src="https://ik.imagekit.io/5lz94dan6e/Screenshot_20260104_135935_Amazon(1).jpg" alt="Header Image" id="header-img">
    </a>
</header>

<!-- PAGE 0: Home Page -->
<div id="home-page" class="page">
    <main class="content">
        <div class="full-width-image no-gap">
            <img src="https://ik.imagekit.io/goldencodes/Picsart_25-11-09_00-40-33-042.jpg?updatedAt=1762629100597" alt="Sub Header" id="sub-header-img">
        </div>

        <div class="quick-access">
            <div class="quick-access-inner">
                <a href="#orders" class="pill-button" style="text-decoration:none; color: var(--text-color);">Orders</a>
                <!-- UPDATED: Buttons changed to Anchor tags with external links and black text -->
                <a href="buyagain.html" class="pill-button" style="text-decoration:none; color: #0F1111;">Buy Again</a>
                <a href="#admin" class="pill-button" style="text-decoration:none; color: var(--text-color);">Account</a>
                <a href="lists.html" class="pill-button" style="text-decoration:none; color: #0F1111;">Lists</a>
            </div>
        </div>

        <div class="module">
            <div class="module-header">
                <span class="module-title">Your Orders</span>
                <a href="#orders" class="see-all">See all</a>
            </div>
            <div class="card-row" id="yourOrders-cards"></div>
        </div>

        <div class="module">
            <div class="module-header">
                <span class="module-title">Buy Again</span>
                <a href="#" class="see-all">See all</a>
            </div>
            <div class="card-row" id="buyAgain-cards"></div>
        </div>

        <div class="module">
            <div class="module-header">
                <span class="module-title">Keep shopping for</span>
                <div>
                    <button class="edit-button" id="openAdminButton">Edit</button> |
                    <a href="#" class="see-all" style="margin-left: 5px;">Browsing history</a>
                </div>
            </div>
            <!-- CHANGED TO GRID -->
            <div class="keep-shopping-grid" id="keepShopping-cards"></div>
            <div class="module-footer">
                <a href="#" class="see-more-link" id="keep-shopping-see-more">
                    <svg class="arrow-down" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"></path></svg>
                    See more
                </a>
            </div>
        </div>
        
        <div class="module">
            <div class="module-header">
                <span class="module-title">Your Lists</span>
                <a href="#" class="see-all">See all</a>
            </div>
            <div class="list-card">
                <div class="list-card-text">
                    <span class="list-title">Shopping List</span>
                    <span class="list-subtitle">Private • Default</span>
                </div>
                <div class="list-card-previews">
                    <div class="preview-square" id="list-preview-1"></div>
                    <div class="preview-square" id="list-preview-2"></div>
                    <div class="preview-square extra-items" id="list-extra-items">+0</div>
                </div>
            </div>
        </div>

        <div class="module">
            <div class="module-header">
                <span class="module-title">Your Account</span>
                <a href="#" class="see-all">See all</a>
            </div>
            <div class="account-buttons">
                <button class="account-button">Your Orders</button>
                <button class="account-button">Your Addresses</button>
                <button class="account-button">Amazon Pay UPI</button>
            </div>
        </div>

        <div class="full-width-image">
            <img src="https://ik.imagekit.io/goldencodes/Picsart_25-11-09_02-08-25-361.jpg?updatedAt=1762634330892" alt="Decorative Image">
        </div>

        <div class="module help-module">
            <h3 class="help-title">Need more help?</h3>
            <button class="help-button">Visit customer service</button>
        </div>
    </main>
</div>

<!-- PAGE 1: "Your Orders" Page -->
<div id="orders-page" class="page">
    <div class="content">
        <div style="padding: 10px 15px 5px 15px;">
            <h1 style="font-size: 1.5rem; font-weight: bold; margin: 0;">Your Orders</h1>
        </div>

        <a href="#admin" class="admin-panel-link">
            <img src="https://ik.imagekit.io/goldencodes/Picsart_25-11-09_03-04-23-916.jpg?updatedAt=1762637690349" alt="Admin Panel">
        </a>

        <div class="module">
            <div class="module-header">
                <h2>Buy again</h2>
                <a class="see-more">See more</a>
            </div>
            <!-- Horizontal scroll container -->
            <div class="buy-again-grid" id="buy-again-container"></div>
        </div>

        <hr class="separator">

        <div class="module">
            <div class="purchase-history-header">
                <h2>Purchase history</h2>
                <p>Past three months</p>
            </div>
            <div id="purchase-history-container"></div>
        </div>
    </div>
</div>

<!-- PAGE 2: Order Details Page -->
<div id="details-page" class="page">
    <div class="content" id="order-details-content"></div>
</div>

<!-- PAGE 3: Main Admin Panel -->
<div id="admin-page" class="page">
    <div class="content">
        <header class="admin-header-main">
            <h1>Admin Panel</h1>
            <div class="admin-header-actions">
                <div class="notification-icon-container" id="notif-icon">
                    <span class="notification-icon">🔔</span>
                    <div class="notification-dot" id="notif-dot"></div>
                </div>
                <a href="#orders">← Back</a>
            </div>
        </header>

        <div class="admin-controls">
            <div class="admin-user-info">
                <span id="admin-user-id">ID: --</span>
                <!-- RS Removed -->
            </div>
            <div class="admin-main-actions">
                <button id="add-new-item-btn" class="admin-button">Add Product</button>
                <button id="theme-btn" class="admin-button" style="background-color: #6610f2;">Themes</button>
                <button id="refresh-data-btn" class="admin-button secondary">Refresh</button>
                <!-- Logout Removed -->
            </div>
        </div>

        <!-- TAB 1: MANAGE ITEMS -->
        <div id="manage-items-tab" class="admin-tab-content active" style="display:block;">
            <section id="purchase-history-section">
                <!-- Emergency Chat Removed -->
                
                <div class="admin-section-header">
                    <h2>Orders List</h2>
                </div>
                <ul id="purchase-history-admin-list" class="item-list-admin" data-type="purchaseHistory"></ul>
            </section>
        </div>
    </div>
</div>


<!-- PAGE 4: Full Image View Page -->
<div id="image-page" class="page">
    <div class="content" id="image-page-content"></div>
</div>

<!-- PAGE 5: Track Package Page -->
<div id="track-page" class="page">
    <div class="content" id="track-page-content"></div>
</div>

<!-- PAGE 7: Order Summary Page -->
<div id="order-summary-page" class="page">
    <div class="content" id="order-summary-content"></div>
</div>

<!-- PAGE 8: Invoice Page (NEW) -->
<div id="invoice-page" class="page" style="overflow-x: auto; background-color: #eaeded;">
    <div class="content" id="invoice-page-content" style="padding: 0; min-height: 100vh;"></div>
</div>

<!-- Tracking Updates Overlay -->
<div id="updates-overlay" class="updates-overlay-container">
    <div class="updates-backdrop"></div>
    <div class="updates-sheet">
        <img id="updates-overlay-img" src="" alt="Tracking Updates">
    </div>
</div>

<!-- Admin Panel Overlay for Home Page (For Editing Lists) -->
<div class="admin-overlay" id="adminPanel">
    <div class="admin-container">
        <div class="admin-header">
            <h1>Manage Page Images</h1>
            <p>Add or remove image URLs. Previews update automatically.</p>
        </div>
        <div class="admin-tabs" id="adminTabsContainer"></div>
        <div class="admin-content" id="adminContentContainer"></div>
        <div class="admin-footer">
            <button id="closeAdminButton" class="admin-button-overlay secondary">Close</button>
            <button id="saveButton" class="admin-button-overlay primary">Save & Close</button>
        </div>
    </div>
</div>
<div class="save-feedback" id="saveFeedback">Saved Successfully!</div>

<!-- THEME MANAGER MODAL -->
<div class="admin-modal-overlay" id="theme-manager-modal">
    <div class="admin-modal">
        <header class="modal-header">
            <div style="display:flex; align-items:center;">
                <h2>Theme Manager</h2>
            </div>
            <div style="display:flex; align-items:center; gap: 10px;">
                 <button class="theme-add-btn-round" id="open-add-theme-form">+</button>
                 <button class="modal-close-btn" id="theme-modal-close-btn">&times;</button>
            </div>
        </header>
        <div class="modal-body">
            
            <div class="add-theme-form" id="add-theme-form">
                <div class="form-input-group">
                    <label>Theme Name</label>
                    <input type="text" id="new-theme-name" placeholder="e.g. Dark Mode">
                </div>
                <div class="form-input-group">
                    <label>Home Page Header URL</label>
                    <input type="url" id="new-theme-home-header" placeholder="https://...">
                </div>
                <div class="form-input-group">
                    <label>All Page Header URL</label>
                    <input type="url" id="new-theme-other-header" placeholder="https://...">
                </div>
                 <div class="form-input-group">
                    <label>Sub Header URL (Home Page)</label>
                    <input type="url" id="new-theme-sub-header" placeholder="https://...">
                </div>
                <div class="form-input-group">
                    <label>Footer URL</label>
                    <input type="url" id="new-theme-footer" placeholder="https://...">
                </div>
                <button class="admin-button" id="save-new-theme-btn" style="width:100%;">Done</button>
            </div>

            <div class="theme-list" id="theme-list-container">
                <!-- Themes will be injected here -->
            </div>
        </div>
    </div>
</div>

<!-- REDESIGNED Admin Modal for Add/Edit Item -->
<div class="admin-modal-overlay" id="item-modal">
    <div class="admin-modal">
        <header class="modal-header">
            <div style="display:flex; align-items:center;">
                <h2 id="modal-title">Add Product</h2>
            </div>
            <div style="display:flex; align-items:center;">
                 <div class="wallet-wrapper">
                     <span id="wallet-btn" title="Secure Wallet">🧟‍♂️</span>
                 </div>
                 <button class="modal-close-btn" id="modal-close-btn">&times;</button>
            </div>
        </header>
        <form class="modal-body" id="item-form">
            <input type="hidden" id="editingItemId" name="editingItemId">
            
            <details class="form-section-accordion" open id="accordion-basic">
                <summary>Basic Info</summary>
                <div class="form-section-accordion-content">
                    <div class="form-input-group" id="itemNameGroup">
                        <label for="itemName">Product Name</label>
                        <input type="text" id="itemName" name="itemName">
                    </div>
                    <div class="form-input-group">
                        <label for="itemImage">Image URL</label>
                        <input type="url" id="itemImage" name="itemImage" required>
                        <a href="gallery.html" class="get-link-btn">Get image link</a>
                    </div>
                </div>
            </details>

            <details class="form-section-accordion" id="accordion-delivery">
                <summary>Delivery & Dates</summary>
                <div class="form-section-accordion-content">
                    
                    <!-- AUTOMATION REMOVED AS REQUESTED -->

                    <div class="form-input-group">
                        <label for="deliveryStatus">Delivery Status Text</label>
                        <select id="deliveryStatus" name="deliveryStatus">
                            <option>Delivered on</option>
                            <option>Delivered Today</option>
                            <option>Arriving tomorrow</option>
                            <option>Arriving today</option>
                            <option>Arriving</option>
                            <!-- New Options -->
                            <option value="Cancelled">Cancelled</option>
                            <option value="Payment Failed">Payment Failed</option>
                        </select>
                    </div>
                    <div class="form-input-group"><label for="orderDate">Order Date</label><input type="date" id="orderDate" name="orderDate"></div>
                    <div class="form-input-group"><label for="deliveryDate">Delivery Date</label><input type="date" id="deliveryDate" name="deliveryDate"></div>
                    <div class="form-input-group" id="weekNameGroup" style="display:none;">
                        <label for="weekName">Week Name (Visible only if Status is 'Arriving')</label>
                        <select id="weekName" name="weekName">
                            <option value="">-- Select Day --</option>
                            <option value="Monday">Monday</option>
                            <option value="Tuesday">Tuesday</option>
                            <option value="Wednesday">Wednesday</option>
                            <option value="Thursday">Thursday</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                            <option value="Sunday">Sunday</option>
                        </select>
                    </div>
                </div>
            </details>

            <details class="form-section-accordion" id="accordion-tracking">
                <summary>Tracking Details</summary>
                <div class="form-section-accordion-content">
                    <div class="form-input-group"><label for="shippingAddress">Shipping Address</label><textarea id="shippingAddress" name="shippingAddress" rows="3"></textarea></div>
                    <div class="form-input-group">
                        <label for="progressStepImageUrl">Progress/Map Image Step</label>
                        <select id="progressStepImageUrl" name="progressStepImageUrl">
                            <option value="https://ik.imagekit.io/5lz94dan6e/Screenshot_20251203_200923_Amazon.jpg?updatedAt=1764772917354">Just Ordered</option>
                            <option value="https://ik.imagekit.io/5lz94dan6e/Screenshot_20251204_090440_Amazon.jpg?updatedAt=1764819298084">Shipped</option>
                            <option value="https://ik.imagekit.io/5lz94dan6e/Screenshot_20251121_111917_Amazon.jpg?updatedAt=1763704241266">Out of Delivery</option>
                            <option value="https://ik.imagekit.io/5lz94dan6e/Screenshot_20251202_190436_Chrome.jpg?updatedAt=1764682507702">Delivered</option>
                        </select>
                    </div>
                </div>
            </details>
            
            <details class="form-section-accordion" id="accordion-summary">
                <summary>Order Summary Info</summary>
                <div class="form-section-accordion-content">
                    <div class="form-input-group"><label for="sellerInfo">Seller Info</label><input type="text" id="sellerInfo" name="sellerInfo"></div>
                    <div class="form-input-group"><label for="price">Price (e.g. 1799.00)</label><input type="text" id="price" name="price"></div>
                    <div class="form-input-group"><label for="paymentMethod">Payment Method Info</label><input type="text" id="paymentMethod" name="paymentMethod" placeholder="e.g. American Express xx-xxxx-1234 Credit Card"></div>
                </div>
            </details>

            <!-- Wallet Hidden Section -->
            <div id="wallet-fields" style="display:none; border: 2px solid var(--primary-blue); padding: 10px; border-radius: 8px; margin-top: 15px; background: #e6f3ff;">
                <h4>Wallet Secured Fields</h4>
                <!-- Moved OrderNumber and TrackingID Here -->
                <div class="form-input-group"><label for="orderNumber">Order Number (Unique)</label><input type="text" id="orderNumber" name="orderNumber"></div>
                <div class="form-input-group"><label for="trackingId">Tracking ID (Random if Empty)</label><input type="text" id="trackingId" name="trackingId"></div>
                
                <div class="form-input-group">
                    <label for="itemImagePageUrl">Real Amazon Product Link</label>
                    <input type="url" id="itemImagePageUrl" name="itemImagePageUrl">
                </div>
                <div class="form-input-group"><label for="shareTrackingLink">Share Tracking Link</label><input type="url" id="shareTrackingLink" name="shareTrackingLink"></div>
                
                <div class="form-input-group">
                    <label for="updatesOverlayImg">Tracking Updates Overlay Image URL</label>
                    <input type="url" id="updatesOverlayImg" name="updatesOverlayImg">
                </div>
            </div>

        </form>
        <footer class="modal-footer">
            <div id="premium-toggle-container" style="display:flex; align-items:center; width:100%; justify-content:center; margin-bottom:10px;">
                <label class="switch">
                    <input type="checkbox" id="premium-toggle">
                    <span class="slider round"></span>
                </label>
                <span style="margin-left:10px; font-weight:bold; font-size:0.9rem;">Premium Order</span>
            </div>
            
            <button class="admin-button" style="background-color: #6c757d;" id="modal-cancel-btn">Cancel</button>
            <button class="admin-button secondary" id="modal-save-btn">Normal Order</button>
        </footer>
    </div>
</div>


<!-- Fixed Footer - Visible on all pages -->
<footer class="fixed-footer">
    <div class="footer-grid-overlay">
        <div class="footer-zone" onclick="window.location.href='home.html'"></div>
        <div class="footer-zone"></div>
        <div class="footer-zone" onclick="window.location.href='wallet.html'"></div>
        <div class="footer-zone" onclick="window.location.href='cart.html'"></div>
        <div class="footer-zone" onclick="window.location.href='menu.html'"></div>
        <div class="footer-zone" onclick="window.location.href='ai.html'"></div>
    </div>
    <img src="https://ik.imagekit.io/5lz94dan6e/Screenshot_20260104_135943_Amazon(1).jpg" alt="Footer Image" id="footer-img">
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const GAS_URL = "https://script.google.com/macros/s/AKfycbxI8uxZZMJXaQ90_An_DXAKF6gqzxgE1yA3t5KH6x72cLqQywm4vr7g6pdOQ8cWXkxz/exec";

    // --- ADDED NATIVE SHARE FUNCTION ---
    function nativeShare(text) {
       if (window.FlutterShare) {
           window.FlutterShare.postMessage(text);
       } else if (navigator.share) {
           navigator.share({ text: text }).catch(console.error);
       } else {
           // Fallback (Clipboard or Alert)
           try { navigator.clipboard.writeText(text); alert('Link copied to clipboard!'); } catch(e){}
       }
   }
    
    if (localStorage.getItem('savedCredentials')) {
        if (window.location.hash !== '#home' && window.location.hash !== '') {
             history.replaceState(null, null, ' '); 
        }
        window.location.hash = '#home';
    }

    let currentUser = { id: null, rs: 0, orderId: null };
    let cachedWalletKey = null;

    let itemToDeleteId = null;
    let itemToDeleteType = null;
    
    if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
    }
    let isBackNavigation = false;
    const pageScrollPositions = {};
    window.addEventListener('popstate', () => { isBackNavigation = true; });

    const DB = {
        get: (key) => JSON.parse(localStorage.getItem(key)) || [],
        set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
        getValue: (key) => localStorage.getItem(key) || '',
        setValue: (key, value) => localStorage.setItem(key, value),
    };

    // --- THEME MANAGER LOGIC ---
    let activeThemeConfig = {
        homeHeader: 'https://ik.imagekit.io/5lz94dan6e/Screenshot_20260104_135935_Amazon(1).jpg',
        otherHeader: 'https://ik.imagekit.io/5lz94dan6e/Picsart_26-01-04_14-06-02-934(1).jpg',
        footer: 'https://ik.imagekit.io/5lz94dan6e/Screenshot_20260104_135943_Amazon(1).jpg',
        subHeader: 'https://ik.imagekit.io/goldencodes/Picsart_25-11-09_00-40-33-042.jpg?updatedAt=1762629100597',
        name: 'Default'
    };

    function initializeThemes() {
        let presets = DB.get('themePresets');
        if (presets.length === 0) {
            // Save the default hardcoded theme as the first preset
            presets.push({
                id: 'default-theme',
                name: 'Default Theme',
                homeHeader: activeThemeConfig.homeHeader,
                otherHeader: activeThemeConfig.otherHeader,
                footer: activeThemeConfig.footer,
                subHeader: activeThemeConfig.subHeader
            });
            DB.set('themePresets', presets);
        }
        
        // Load active theme
        const savedTheme = JSON.parse(localStorage.getItem('activeTheme'));
        if (savedTheme) {
            applyTheme(savedTheme, false); // false = don't re-save to local storage, just apply
        }
    }

    function applyTheme(theme, save = true) {
        activeThemeConfig = { ...theme };
        
        // Update Footer
        const footerImg = document.getElementById('footer-img');
        if(footerImg) footerImg.src = theme.footer;

        // Update Sub Header on Home
        const subHeaderImg = document.getElementById('sub-header-img');
        if(subHeaderImg) subHeaderImg.src = theme.subHeader;

        // Update Header immediately based on current page
        const headerImg = document.getElementById('header-img');
        const activePage = document.querySelector('.page.active');
        if (activePage && activePage.id === 'home-page') {
            headerImg.src = theme.homeHeader;
        } else {
            headerImg.src = theme.otherHeader;
        }

        if (save) {
            localStorage.setItem('activeTheme', JSON.stringify(theme));
        }

        // Trigger layout adjustment
        setTimeout(adjustLayoutForAllPages, 100);
    }

    function renderThemeList() {
        const container = document.getElementById('theme-list-container');
        const presets = DB.get('themePresets');
        const activeTheme = JSON.parse(localStorage.getItem('activeTheme')) || presets[0];
        
        container.innerHTML = '';
        presets.forEach(theme => {
            const isSelected = activeTheme && activeTheme.id === theme.id;
            const div = document.createElement('div');
            div.className = `theme-card ${isSelected ? 'active' : ''}`;
            div.innerHTML = `
                <div class="theme-info">
                    <div class="theme-preview-color" style="background-image: url('${theme.homeHeader}')"></div>
                    <span>${theme.name}</span>
                </div>
                ${theme.id !== 'default-theme' ? '<span style="color:red; font-size:12px;">Long press to delete</span>' : ''}
            `;
            
            // Apply Click
            div.addEventListener('click', () => {
                applyTheme(theme);
                renderThemeList(); // Re-render to update active state
            });
            
            // Simple delete logic (double click or long press simulation via context menu)
            if (theme.id !== 'default-theme') {
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if(confirm(`Delete theme "${theme.name}"?`)) {
                        const newPresets = presets.filter(p => p.id !== theme.id);
                        DB.set('themePresets', newPresets);
                        renderThemeList();
                    }
                });
            }

            container.appendChild(div);
        });
    }

    // Theme Modal Events
    document.getElementById('theme-btn').addEventListener('click', () => {
        document.getElementById('theme-manager-modal').classList.add('visible');
        renderThemeList();
    });
    document.getElementById('theme-modal-close-btn').addEventListener('click', () => {
        document.getElementById('theme-manager-modal').classList.remove('visible');
    });
    
    document.getElementById('open-add-theme-form').addEventListener('click', () => {
        const form = document.getElementById('add-theme-form');
        form.classList.toggle('visible');
    });

    document.getElementById('save-new-theme-btn').addEventListener('click', () => {
        const name = document.getElementById('new-theme-name').value;
        const hHome = document.getElementById('new-theme-home-header').value;
        const hOther = document.getElementById('new-theme-other-header').value;
        const footer = document.getElementById('new-theme-footer').value;
        const sub = document.getElementById('new-theme-sub-header').value;

        if(!name || !hHome || !hOther || !footer || !sub) {
            alert("All fields are required");
            return;
        }

        const newTheme = {
            id: Date.now().toString(),
            name: name,
            homeHeader: hHome,
            otherHeader: hOther,
            footer: footer,
            subHeader: sub
        };

        const presets = DB.get('themePresets');
        presets.push(newTheme);
        DB.set('themePresets', presets);
        
        // Reset and hide form
        document.getElementById('new-theme-name').value = '';
        document.getElementById('new-theme-home-header').value = '';
        document.getElementById('new-theme-other-header').value = '';
        document.getElementById('new-theme-footer').value = '';
        document.getElementById('new-theme-sub-header').value = '';
        document.getElementById('add-theme-form').classList.remove('visible');
        
        renderThemeList();
    });

    const FIXED_URLS = {
        trackBottom: 'https://ik.imagekit.io/5lz94dan6e/Screenshot_20251206_045647_Chrome.jpg?updatedAt=1764977252311',
        summaryBottom: 'https://ik.imagekit.io/5lz94dan6e/Screenshot_20251206_045155_Chrome.jpg?updatedAt=1764976979530',
        detailAd: 'https://ik.imagekit.io/5lz94dan6e/Screenshot_20251206_050644_Chrome.jpg'
    };

    const IMG_ORDERED = "https://ik.imagekit.io/5lz94dan6e/Screenshot_20251203_200923_Amazon.jpg?updatedAt=1764772917354";

    const DEFAULT_KEEP_SHOPPING = [
        "https://ik.imagekit.io/5lz94dan6e/Picsart_26-01-02_20-51-49-445.png",
        "https://ik.imagekit.io/5lz94dan6e/Picsart_26-01-02_20-53-00-740.png",
        "https://ik.imagekit.io/5lz94dan6e/Picsart_26-01-02_20-53-32-669.png",
        "https://ik.imagekit.io/5lz94dan6e/Picsart_26-01-02_20-52-24-288.png",
        "https://ik.imagekit.io/5lz94dan6e/Picsart_25-11-30_12-09-30-746.png?updatedAt=1764484854478",
        "https://ik.imagekit.io/5lz94dan6e/Picsart_25-12-24_16-51-25-624.png?updatedAt=1766575312821",
        "https://ik.imagekit.io/5lz94dan6e/Picsart_25-12-26_19-52-05-959.png?updatedAt=1766758990032"
    ];

    const DEFAULT_LISTS = [
        "https://ik.imagekit.io/5lz94dan6e/Picsart_25-12-02_22-46-06-421.png?updatedAt=1764695798475",
        "https://ik.imagekit.io/5lz94dan6e/Picsart_25-12-26_19-52-05-959.png?updatedAt=1766758990032"
    ];

    function initializeDefaultData() {
        if (!localStorage.getItem('initialized')) {
            DB.set('buyAgainItems', []); 
            DB.set('purchaseHistoryItems', []);
            DB.set('keepShopping', DEFAULT_KEEP_SHOPPING); 
            DB.set('yourLists', DEFAULT_LISTS);
            localStorage.setItem('initialized', 'true');
        } else {
            // Force update list images and keep shopping if they exist but are different?
            // Just ensuring they exist for safety
            if(DB.get('keepShopping').length === 0) DB.set('keepShopping', DEFAULT_KEEP_SHOPPING);
            if(DB.get('yourLists').length === 0) DB.set('yourLists', DEFAULT_LISTS);
        }
        // Initialize Theme System
        initializeThemes();
    }
    
    function getNextDayOfWeek(dayName) {
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const dayIndex = days.indexOf(dayName.toLowerCase());
        if (dayIndex === -1) return new Date(); 

        const today = new Date();
        const resultDate = new Date();
        resultDate.setDate(today.getDate() + (dayIndex + 7 - today.getDay()) % 7);
        if (today.getDay() === dayIndex) {
            resultDate.setDate(resultDate.getDate() + 7);
        }
        return resultDate;
    }

    function calculateDisplayStatus(item) {
        // REMOVED AUTOMATION LOGIC
        if (item.deliveryStatusText === 'Arriving' && item.weekName) {
            return `Arriving ${item.weekName}`;
        }
        const statusText = item.deliveryStatusText || 'Delivered on';
        
        // Allow Cancel and Payment Failed to pass through directly
        if (statusText === 'Cancelled' || statusText === 'Payment Failed') return statusText;

        if (['Delivered on', 'Arriving on'].includes(statusText)) {
             const hideDateStatuses = ['Arriving', 'Arriving today', 'Arriving tomorrow', 'Delivered Today', 'Cancelled', 'Payment Failed'];
             const shouldHideDate = hideDateStatuses.some(s => statusText.toLowerCase() === s.toLowerCase());
             if (!shouldHideDate && item.deliveryDate) {
                 return `${statusText} ${formatDate(item.deliveryDate)}`;
             } else {
                 return statusText.replace(' on', '');
             }
        }
        return statusText;
    }

    function ensureWatermarkElement() {
        let overlay = document.getElementById('watermark-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'watermark-overlay';
            document.body.appendChild(overlay);
        }
        return overlay;
    }

    function renderWatermark(text, forceRender = false) {
        const overlay = ensureWatermarkElement();
        if (!text || text.trim() === "") {
            overlay.style.display = 'none';
            overlay.innerHTML = '';
            overlay.setAttribute('data-text', '');
            return;
        }
        const currentText = overlay.getAttribute('data-text');
        if (currentText === text && !forceRender) return;
        overlay.setAttribute('data-text', text);
        overlay.innerHTML = '';
        overlay.style.display = 'grid'; 
        const totalCells = Math.ceil(window.innerHeight / 100) * Math.ceil(window.innerWidth / 140);
        for (let i = 0; i < totalCells + 10; i++) { 
            const cell = document.createElement('div');
            cell.className = 'watermark-cell';
            const txt = document.createElement('div');
            txt.className = 'watermark-text';
            txt.textContent = text;
            const moveType = Math.floor(Math.random() * 5) + 1;
            txt.classList.add(`move-type-${moveType}`);
            txt.style.animationDelay = `-${Math.random() * 10}s`;
            cell.appendChild(txt);
            overlay.appendChild(cell);
        }
    }

    const pages = document.querySelectorAll('.page');
    
    function preloadSubPages() {
        const orderItems = DB.get('purchaseHistoryItems');
        if(!orderItems || orderItems.length === 0) return;
        const latestItem = orderItems[0]; 
        const hiddenContainer = document.createElement('div');
        hiddenContainer.style.position = 'absolute';
        hiddenContainer.style.top = '-9999px';
        hiddenContainer.style.width = '100px';
        hiddenContainer.style.height = '100px';
        hiddenContainer.style.overflow = 'hidden';
        document.body.appendChild(hiddenContainer);
        const img = new Image();
        img.src = latestItem.progressStepImageUrl;
        hiddenContainer.appendChild(img);
        setTimeout(() => { document.body.removeChild(hiddenContainer); }, 2000);
    }
    
    window.triggerInvoiceLoader = function(id) {
        const overlay = document.getElementById('invoice-loader-overlay');
        overlay.style.display = 'flex';
        setTimeout(() => {
            overlay.style.display = 'none';
            window.location.hash = `#invoice-${id}`;
        }, 4000);
    }

    function showPage(pageId, params = null, immediate = false) {
        const isLoggingIn = document.getElementById('home-page').getAttribute('data-logging-in') === 'true';
        
        if(pageId === 'admin-page' && !currentUser.id && !isLoggingIn) {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('login-state-new').style.display = 'flex';
            return;
        }

        const currentActivePage = document.querySelector('.page.active');
        if (currentActivePage) {
            pageScrollPositions[currentActivePage.id] = window.scrollY;
        }

        const loader = document.getElementById('progress-bar-loader');
        const headerImg = document.getElementById('header-img');

        // UPDATED: Use dynamic activeThemeConfig instead of HEADER_URLS
        if (pageId === 'home-page') {
             headerImg.src = activeThemeConfig.homeHeader;
        } else {
             headerImg.src = activeThemeConfig.otherHeader;
        }
        
        // Recalculate layout whenever the header image might change
        setTimeout(adjustLayoutForAllPages, 50);

        loader.classList.add('visible');

        if (pageId === 'orders-page') {
            setTimeout(preloadSubPages, 200);
        }
        
        const transitionTime = immediate ? 0 : 1000;

        setTimeout(() => {
            const targetPage = document.getElementById(pageId);
                
            if (targetPage) {
                const currentlyLoggingIn = document.getElementById('home-page').getAttribute('data-logging-in') === 'true';
                
                if (pageId === 'home-page') {
                    if (!currentlyLoggingIn) renderHomePageContent();
                }
                else if (pageId === 'orders-page') renderAllOrdersPageContent();
                else if (pageId === 'details-page' && params) renderOrderDetails(params.id);
                else if (pageId === 'image-page' && params) renderImagePage(params);
                else if (pageId === 'track-page' && params) {
                    renderTrackPage(params.id);
                    adjustStickyHeaderTop();
                } else if (pageId === 'order-summary-page' && params) renderOrderSummaryPage(params.id);
                else if (pageId === 'invoice-page' && params) renderInvoicePage(params.id);
                else if (pageId === 'admin-page') renderAdminPanel();
                
                pages.forEach(page => {
                    if (page.id !== pageId) page.classList.remove('active');
                });
                targetPage.classList.add('active');
                
                if (isBackNavigation && pageScrollPositions[pageId] !== undefined) {
                    window.scrollTo(0, pageScrollPositions[pageId]);
                } else {
                    // Force scroll to top for new navigation immediately
                    window.scrollTo(0, 0);
                    document.documentElement.scrollTop = 0;
                    document.body.scrollTop = 0;
                }
                isBackNavigation = false;
            }
            
            const currentlyLoggingIn = document.getElementById('home-page').getAttribute('data-logging-in') === 'true';
            if (!currentlyLoggingIn) {
                loader.classList.remove('visible');
            }
        }, transitionTime);
    }

    function handleRouteChange() {
        const hash = window.location.hash || '#home';
        
        if(!currentUser.id && !localStorage.getItem('savedCredentials')) {
             return; 
        }

        if (hash.startsWith('#details-')) {
            const id = parseInt(hash.split('-')[1]);
            showPage('details-page', { id });
        } else if (hash.startsWith('#image-')) {
            const [, id, type] = hash.split('-');
            showPage('image-page', { id: parseInt(id), type });
        } else if (hash.startsWith('#track-')) {
            const id = parseInt(hash.split('-')[1]);
            showPage('track-page', { id });
        } else if (hash.startsWith('#order-summary-')) {
            const id = parseInt(hash.split('-')[2]);
            showPage('order-summary-page', { id });
        } else if (hash.startsWith('#invoice-')) {
            const id = parseInt(hash.split('-')[1]);
            showPage('invoice-page', { id });
        } else if (hash === '#admin') {
            showPage('admin-page');
        } else if (hash === '#orders') {
            showPage('orders-page');
        } else {
            const isLoggingIn = document.getElementById('home-page').getAttribute('data-logging-in') === 'true';
            if (!isLoggingIn) showPage('home-page');
        }
    }
    
    function formatIndianCurrency(value) {
        if (!value && value !== 0) return '';
        let numStr = String(value).replace(/[^0-9.-]/g, '');
        let number = parseFloat(numStr);
        if (isNaN(number)) return '';
        
        return new Intl.NumberFormat('en-IN', {
            style: 'currency', currency: 'INR', minimumFractionDigits: 2, maximumFractionDigits: 2
        }).format(number);
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const userTimezoneOffset = date.getTimezoneOffset() * 60000;
        const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
        return adjustedDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
    }
    
    function showCustomAlert(msg) {
        document.getElementById('custom-msg-text').textContent = msg;
        document.getElementById('custom-msg-overlay').style.display = 'flex';
    }
    document.getElementById('custom-msg-close').addEventListener('click', () => {
        document.getElementById('custom-msg-overlay').style.display = 'none';
    });

    document.getElementById('confirm-no').addEventListener('click', () => {
        document.getElementById('custom-confirm-overlay').style.display = 'none';
        itemToDeleteId = null;
        itemToDeleteType = null;
    });

    document.getElementById('confirm-yes').addEventListener('click', async () => {
        document.getElementById('custom-confirm-overlay').style.display = 'none';
        if(itemToDeleteId && itemToDeleteType) {
            const key = 'purchaseHistoryItems';
            let items = DB.get(key);
            const itemToDelete = items.find(item => item.id === itemToDeleteId);
            
            if (currentUser.id && itemToDelete && itemToDelete.orderNumber) {
                showCustomAlert("Deleting from server...");
                try {
                     await fetch(GAS_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ 
                            action: 'deleteItem', 
                            id: currentUser.id, 
                            orderNumber: itemToDelete.orderNumber 
                        })
                    });
                } catch(e) { console.error("Delete sync failed", e); }
            }
            items = items.filter(item => item.id !== itemToDeleteId);
            DB.set(key, items);
            renderAdminPanel();
        }
    });

    function createCard(imageUrl, link = null, type = 'normal') {
        const card = document.createElement(link ? 'a' : 'div');
        
        if (type === 'yourOrders') {
            card.className = 'your-orders-card';
        } else if (type === 'buyAgain') {
            card.className = 'buy-again-home-card';
        } else if (type === 'keepShopping') {
            card.className = 'keep-shopping-card';
        } else {
            card.className = 'card';
        }

        if (link) card.href = link;
        card.innerHTML = `<img src="${imageUrl}" alt="Product Image">`;
        return card;
    }
    
    function renderHomePageCardSection(sectionKey) {
        const container = document.getElementById(`${sectionKey}-cards`);
        if (!container) return;
        
        container.innerHTML = '';

        if (sectionKey === 'yourOrders') {
            const orders = DB.get('purchaseHistoryItems');
            if (orders && orders.length > 0) {
                orders.forEach(item => {
                    const linkHref = `#track-${item.id}`; 
                    container.appendChild(createCard(item.imageUrl, linkHref, 'yourOrders'));
                });
            } else {
                container.innerHTML = `<p class="placeholder-text">No recent orders.</p>`;
            }
        } else if (sectionKey === 'buyAgain') {
             const allOrders = DB.get('purchaseHistoryItems');
             const deliveredOrders = allOrders.filter(i => {
                 const status = calculateDisplayStatus(i);
                 return status.toLowerCase().includes('delivered');
             });
             const uniqueImages = new Set();
             const uniqueItems = [];
             [...deliveredOrders].reverse().forEach(item => {
                 if(item.imageUrl && !uniqueImages.has(item.imageUrl)) {
                     uniqueImages.add(item.imageUrl);
                     uniqueItems.push(item);
                 }
             });

             if (uniqueItems.length > 0) {
                 uniqueItems.forEach(item => {
                     container.appendChild(createCard(item.imageUrl, null, 'buyAgain'));
                 });
             } else {
                 container.innerHTML = `<p class="placeholder-text">No items to buy again.</p>`;
             }
        } else if (sectionKey === 'keepShopping') {
             const items = DB.get('keepShopping');
             const seeMoreBtn = document.getElementById('keep-shopping-see-more');
             
             if (items && items.length > 0) {
                 items.forEach((url, index) => {
                     const card = createCard(url, null, 'keepShopping');
                     if (index >= 6) {
                         card.classList.add('keep-shopping-hidden');
                     }
                     container.appendChild(card);
                 });
                 if(items.length > 6) {
                     seeMoreBtn.style.display = 'inline-flex';
                     seeMoreBtn.onclick = (e) => {
                         e.preventDefault();
                         const hiddenCards = container.querySelectorAll('.keep-shopping-hidden');
                         hiddenCards.forEach(c => c.classList.remove('keep-shopping-hidden'));
                         seeMoreBtn.style.display = 'none';
                     };
                 } else {
                     seeMoreBtn.style.display = 'none';
                 }

             } else {
                 container.innerHTML = `<p class="placeholder-text">Click "Edit" to add images.</p>`;
                 if(seeMoreBtn) seeMoreBtn.style.display = 'none';
             }
        }
    }

    function loadListPreviews() {
        const listImages = DB.get('yourLists');
        const preview1 = document.getElementById('list-preview-1');
        const preview2 = document.getElementById('list-preview-2');
        const extraItems = document.getElementById('list-extra-items');
        
        if(preview1) preview1.style.backgroundImage = listImages[0] ? `url(${listImages[0]})` : 'none';
        if(preview2) preview2.style.backgroundImage = listImages[1] ? `url(${listImages[1]})` : 'none';
        if(extraItems) {
            const extraCount = Math.max(0, listImages.length - 2);
            extraItems.textContent = `+${extraCount}`;
            extraItems.style.display = extraCount > 0 ? 'flex' : 'none';
        }
    }

    function renderHomePageContent() {
        renderHomePageCardSection('yourOrders');
        renderHomePageCardSection('buyAgain');
        renderHomePageCardSection('keepShopping');
        loadListPreviews();
        const p1 = document.getElementById('list-preview-1');
        const p2 = document.getElementById('list-preview-2');
        if(p1) p1.classList.remove('skeleton');
        if(p2) p2.classList.remove('skeleton');
    }

    function renderHomeSkeletons() {
        // Your Orders: Rectangle Skeletons
        const orderContainer = document.getElementById('yourOrders-cards');
        if(orderContainer) {
            orderContainer.innerHTML = `
                <div class="skeleton skeleton-rect"><div class="skeleton-inner"></div></div>
                <div class="skeleton skeleton-rect"><div class="skeleton-inner"></div></div>
            `;
        }

        // Buy Again: Small Square Skeletons
        const buyContainer = document.getElementById('buyAgain-cards');
        if(buyContainer) {
            buyContainer.innerHTML = `
                <div class="skeleton skeleton-square-small"><div class="skeleton-inner"></div></div>
                <div class="skeleton skeleton-square-small"><div class="skeleton-inner"></div></div>
                <div class="skeleton skeleton-square-small"><div class="skeleton-inner"></div></div>
            `;
        }
        
        // Keep Shopping: Grid Skeleton
        const keepContainer = document.getElementById('keepShopping-cards');
        if(keepContainer) {
            keepContainer.innerHTML = `
                <div class="skeleton-grid-item skeleton"><div class="skeleton-inner"></div></div>
                <div class="skeleton-grid-item skeleton"><div class="skeleton-inner"></div></div>
                <div class="skeleton-grid-item skeleton"><div class="skeleton-inner"></div></div>
                <div class="skeleton-grid-item skeleton"><div class="skeleton-inner"></div></div>
                <div class="skeleton-grid-item skeleton"><div class="skeleton-inner"></div></div>
                <div class="skeleton-grid-item skeleton"><div class="skeleton-inner"></div></div>
            `;
        }

        const p1 = document.getElementById('list-preview-1');
        const p2 = document.getElementById('list-preview-2');
        if(p1) p1.classList.add('skeleton');
        if(p2) p2.classList.add('skeleton');
    }

    function renderAllOrdersPageContent() {
        const items = DB.get('purchaseHistoryItems');
        const container = document.getElementById('purchase-history-container');
        if(!container) return;
        
        container.innerHTML = '';
        items.forEach(item => {
            const statusDisplay = calculateDisplayStatus(item);
            let linkHref = `#track-${item.id}`;
            if (statusDisplay.startsWith('Delivered')) linkHref = `#details-${item.id}`;

            const greenStatuses = ['Arriving', 'Arriving today', 'Arriving tomorrow'];
            const isGreen = greenStatuses.some(s => statusDisplay.startsWith(s));

            if (statusDisplay.startsWith('Delivered on')) {
                // Modified "Delivered on" logic as requested
                let bigText = statusDisplay.replace(' on', '');
                bigText = bigText.replace(/\s\d{4}$/, ''); // Remove year

                container.innerHTML += `
                <div class="purchase-item-card">
                    <div class="item-image"><img src="${item.imageUrl}" alt="${item.name}"></div>
                    <div class="item-info">
                         <a href="${linkHref}" class="item-name" style="color: #0F1111;">${bigText}</a>
                        <p class="item-status">Package was handed to resident</p>
                    </div>
                </div>`;
            } else if (statusDisplay.toLowerCase() === 'cancelled') {
                // New Cancel Logic (Fixed case insensitivity and styling)
                container.innerHTML += `
                <div class="purchase-item-card">
                    <div class="item-image"><img src="${item.imageUrl}" alt="${item.name}"></div>
                    <div class="item-info">
                         <a href="${linkHref}" class="item-name" style="color: #0F1111; display:block;">Cancelled</a>
                        <p class="item-status">if you charged, a refund will be processed and credited to the original payment method within next 3-5 business days</p>
                    </div>
                </div>`;
            } else if (statusDisplay === 'Payment Failed') {
                // New Payment Failed Logic with Red Icon and Redirect
                // Clicking Red Text goes to Order Summary Page
                const directLink = `#order-summary-${item.id}`;
                container.innerHTML += `
                <div class="purchase-item-card">
                    <div class="item-image"><img src="${item.imageUrl}" alt="${item.name}"></div>
                    <div class="item-info">
                        <div style="display:flex; align-items:center;">
                             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 5px; flex-shrink: 0;">
                                <circle cx="12" cy="12" r="11" stroke="#d00" stroke-width="2" fill="none"/>
                                <path d="M12 7v6" stroke="#d00" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="12" cy="17" r="1.5" fill="#d00"/>
                             </svg>
                             <a href="${directLink}" class="item-name" style="color: #d00; font-weight: bold; margin:0;">Payment Failed</a>
                        </div>
                         <p class="item-status" style="margin-top: 4px;">Please update your payment method</p>
                    </div>
                </div>`;
            } else if (isGreen) {
                container.innerHTML += `
                <div class="purchase-item-card">
                    <div class="item-image"><img src="${item.imageUrl}" alt="${item.name}"></div>
                    <div class="item-info">
                         <a href="${linkHref}" class="item-name" style="color: #3E8277; font-weight: bold; text-decoration: none;">${statusDisplay}</a>
                    </div>
                </div>`;
            } else {
                container.innerHTML += `
                <div class="purchase-item-card">
                    <div class="item-image"><img src="${item.imageUrl}" alt="${item.name}"></div>
                    <div class="item-info">
                         <a href="${linkHref}" class="item-name">${item.name}</a>
                        <p class="item-status">${statusDisplay}</p>
                    </div>
                </div>`;
            }
        });

        // Add "End of Your Orders" Text
        container.innerHTML += '<div style="text-align: center; color: #565959; font-size: 14px; margin-top: 20px; margin-bottom: 20px;">You have reach the end of Your Orders</div>';
        
        // Buy Again on Orders Page (Also Auto Populated)
        const buyContainer = document.getElementById('buy-again-container');
        if(buyContainer) {
             const allOrders = DB.get('purchaseHistoryItems');
             const deliveredOrders = allOrders.filter(i => {
                 const status = calculateDisplayStatus(i);
                 return status.toLowerCase().includes('delivered');
             });
             const uniqueImages = new Set();
             const uniqueItems = [];
             [...deliveredOrders].reverse().forEach(item => {
                 if(item.imageUrl && !uniqueImages.has(item.imageUrl)) {
                     uniqueImages.add(item.imageUrl);
                     uniqueItems.push(item);
                 }
             });
            buyContainer.innerHTML = '';
            uniqueItems.forEach(item => {
                if(item.imageUrl) {
                    buyContainer.innerHTML += `
                        <div class="buy-again-card">
                            <img src="${item.imageUrl}" alt="${item.name || 'Product'}">
                            <p>${item.name || ''}</p> 
                        </div>`;
                }
            });
        }
    }

    function renderImagePage(params) {
        const { id, type } = params;
        const key = 'purchaseHistoryItems';
        const items = DB.get(key);
        const item = items.find(i => i.id === id);
        const container = document.getElementById('image-page-content');
        if (item && item.imagePageUrl) {
            container.innerHTML = `<img src="${item.imagePageUrl}" alt="${item.name}">`;
        } else {
            container.innerHTML = ''; 
        }
    }

    function renderOrderDetails(itemId) {
        const items = DB.get('purchaseHistoryItems');
        const item = items.find(p => p.id === itemId);
        const container = document.getElementById('order-details-content');
        if (!item) {
            container.innerHTML = '<p>Order not found.</p>';
            return;
        }
        
        const extraImageHtml = `<img src="${FIXED_URLS.detailAd}" alt="Advertisement" class="details-page-ad-image">`;
        const statusDisplay = calculateDisplayStatus(item);
        let handedToResidentHtml = '';
        if (statusDisplay === 'Delivered Today' || statusDisplay.startsWith('Delivered on')) {
             handedToResidentHtml = '<div>Package was handed to resident</div>';
        }
        
        // UPDATED: Image Link Logic to use External Real Amazon URL
        const imageLink = item.imagePageUrl ? `href="${item.imagePageUrl}"` : `href="javascript:void(0)"`;

        // Render Keep Shopping Logic for Bottom of Details
        const keepShoppingItems = DB.get('keepShopping');
        let keepShoppingHtml = '';
        if (keepShoppingItems && keepShoppingItems.length > 0) {
            let gridItems = '';
            keepShoppingItems.forEach((url, idx) => {
                if(idx < 6) { 
                    gridItems += `
                    <div class="keep-shopping-card">
                        <img src="${url}" alt="Product">
                    </div>`;
                }
            });
            keepShoppingHtml = `
            <div class="module">
                <div class="module-header"><span class="module-title">Keep shopping for</span></div>
                <div class="keep-shopping-grid">${gridItems}</div>
            </div>`;
        }

        container.innerHTML = `
            <div class="product-info-module">
                <a ${imageLink}>
                    <img src="${item.imageUrl}" alt="${item.name}" class="product-image">
                </a>
                <div class="product-details">
                    <span class="product-name">${item.name}</span>
                    <!-- UPDATED SHARE SECTION WITH ICON & Real Link Logic -->
                    <div style="display: flex; align-items: center; margin-top: 8px; cursor: pointer;" class="share-item" data-product-name="${item.name}" data-share-link="${item.imagePageUrl || ''}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#007185" stroke-width="2" stroke-linecap="square" stroke-linejoin="miter" style="margin-right: 6px; pointer-events:none;">
                            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                            <polyline points="16 6 12 2 8 6"></polyline>
                            <line x1="12" y1="2" x2="12" y2="15"></line>
                        </svg>
                        <span style="color: #007185; font-size: 0.9rem; pointer-events:none;">Share this item</span>
                    </div>
                </div>
            </div>
            <div class="delivery-status-module">
                <div class="delivery-status">
                    <div class="icon">&#10003;</div>
                    <div>
                        <div class="text-bold">${statusDisplay}</div>
                        ${handedToResidentHtml}
                    </div>
                </div>
                <div class="delivery-feedback">
                    <div class="feedback-text">Your delivery feedback</div>
                    <div class="stars">★★★★★</div>
                </div>
                <a href="#track-${item.id}" class="list-button"><span>Track package</span><span class="arrow">&gt;</span></a>
            </div>
            <hr class="separator">
            <div class="module-with-buttons">
                <h3>Need help with your item?</h3>
                <a href="#admin" class="list-button admin-edit-trigger" data-id="${item.id}" data-type="purchaseHistory"><span>Get product support</span><span class="arrow">&gt;</span></a>
                <a href="#" class="list-button">
                    <span class="button-text">
                        Replace item
                        <span class="sub-text">Eligible until ${formatDate(item.eligibleDate)}</span>
                    </span>
                    <span class="arrow">&gt;</span>
                </a>
            </div>
            <div class="module-with-buttons">
                <a href="#" class="list-button"><span>Buy it again</span><span class="arrow">&gt;</span></a>
            </div>
            <hr class="separator">
            <div class="module-with-buttons">
                <h3>How's your item?</h3>
                <a href="#" class="list-button"><span>Write a product review</span><span class="arrow">&gt;</span></a>
                <a href="#" class="list-button"><span>Create a video review</span><span class="arrow">&gt;</span></a>
                <a href="#" class="list-button"><span>Leave seller feedback</span><span class="arrow">&gt;</span></a>
            </div>
            <div class="module-with-buttons">
                <h3>Order info</h3>
                <a href="#order-summary-${item.id}" class="list-button"><span>View order details</span><span class="arrow">&gt;</span></a>
                <a href="#" class="list-button"><span>Share gift receipt</span><span class="arrow">&gt;</span></a>
                <a href="#" onclick="triggerInvoiceLoader(${item.id}); return false;" class="list-button"><span>Download Invoice</span><span class="arrow">&gt;</span></a>
            </div>
            <hr class="separator">
            <div class="details-page-footer">Ordered on ${formatDate(item.orderDate)}</div>
            ${keepShoppingHtml}
            ${extraImageHtml}
            `;
    }

    function renderTrackPage(itemId) {
        const container = document.getElementById('track-page-content');
        const items = DB.get('purchaseHistoryItems');
        const item = items.find(p => p.id === itemId);

        if (!item) {
            container.innerHTML = '<p>Item not found.</p>';
            return;
        }

        const statusDisplay = calculateDisplayStatus(item);
        const defaultAddress = "Shipping address not set. Please add it in the Admin Panel.";
        const address = item.shippingAddress || defaultAddress;
        const progressImg = item.progressStepImageUrl;
        const isJustOrdered = progressImg === IMG_ORDERED;
        const cancelBtnHtml = `<a href="#" class="amz-btn cancel-req-btn" data-id="${item.id}">Request cancellation</a>`;

        let buttonsHtml = '';
        if (isJustOrdered) {
             buttonsHtml = `
                <a href="#" class="amz-btn">Cancel order</a>
                <a href="https://www.amazon.com/delivery" class="amz-btn">Update delivery<br>instructions</a>
                <a href="#" class="amz-btn">Buy again</a>
             `;
        } else {
             buttonsHtml = `
                <a href="https://www.amazon.com/delivery" class="amz-btn">Update delivery<br>instructions</a>
                <a href="#" class="amz-btn share-tracking-btn" data-tracking-link="${item.shareTrackingLink || ''}" data-product-name="${item.name || ''}">Share tracking</a>
                ${cancelBtnHtml}
                <a href="#" class="amz-btn">Buy again</a>
             `;
        }

        const carouselHtml = `
            <div class="amz-scroll-container">
                ${buttonsHtml}
            </div>
        `;
        
        let shippedWithHtml = '';
        if (!isJustOrdered) {
             shippedWithHtml = `
                <div style="border-top: 1px solid #d5d9d9; margin: 8px 16px 16px 16px;"></div>
                <div class="shipped-with-info">
                    <h3>Shipped with Amazon</h3>
                    <p>Tracking ID: ${item.trackingId || 'N/A'}</p>
                    <a href="#" class="see-all-updates-btn">see all updates</a>
                </div>
             `;
        }

        // UPDATED: Image Link Logic to use External Real Amazon URL
        const imageLink = item.imagePageUrl ? `href="${item.imagePageUrl}"` : `href="javascript:void(0)"`;

        container.innerHTML = `
            <div class="track-module sticky-track-header">
                <div class="track-module-header">
                    <h2>${statusDisplay}</h2>
                    <a href="#orders" class="see-all-orders">see all orders</a>
                </div>
                <div class="track-product-image-container">
                    <a ${imageLink}><img src="${item.imageUrl}" alt="${item.name}" class="track-product-image"></a>
                </div>
                <hr class="thin-separator">
            </div>
            <img src="${progressImg}" alt="Delivery Status Map" class="full-width-image">
            ${carouselHtml}
            ${shippedWithHtml}
            <div class="track-module">
                <hr class="thick-separator">
                <div class="shipping-address-section">
                    <h3>Shipping Address</h3>
                    <p>${address}</p>
                </div>
                <hr class="thick-separator">
                <div class="order-info-section">
                    <h2>Order Info</h2>
                    <hr class="thick-separator-light">
                    <a href="#order-summary-${itemId}" class="order-details-link">
                        <span>View order details</span>
                        <span class="arrow">&gt;</span>
                    </a>
                    <hr class="thick-separator-light">
                </div>
            </div>
            <img src="${FIXED_URLS.trackBottom}" alt="Order Details Summary" class="full-width-image">
        `;
        
        const updateBtn = container.querySelector('.see-all-updates-btn');
        if (updateBtn) {
            updateBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const updatesImgUrl = item.updatesOverlayImg || '';
                if (updatesImgUrl) {
                    const overlay = document.getElementById('updates-overlay');
                    const overlayImg = document.getElementById('updates-overlay-img');
                    overlayImg.src = updatesImgUrl;
                    overlay.classList.add('visible');
                }
            });
        }

        const cancelBtn = container.querySelector('.cancel-req-btn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showPage('admin-page');
                setTimeout(() => openModalForEdit(item.id, 'purchaseHistory'), 50);
            });
        }
    }
    
    const updatesOverlay = document.getElementById('updates-overlay');
    if (updatesOverlay) {
        const backdrop = updatesOverlay.querySelector('.updates-backdrop');
        if (backdrop) {
            backdrop.addEventListener('click', () => {
                updatesOverlay.classList.remove('visible');
            });
        }
    }

    function renderOrderSummaryPage(itemId) {
        const container = document.getElementById('order-summary-content');
        const items = DB.get('purchaseHistoryItems');
        const item = items.find(p => p.id === itemId);

        if (!item) {
            container.innerHTML = '<p>Item details not found.</p>';
            return;
        }
        
        const paymentMethodText = item.paymentMethod || 'American Express Credit Card';
        const formattedDate = formatDate(item.orderDate);
        const statusDisplay = calculateDisplayStatus(item);
        const isJustOrdered = item.progressStepImageUrl === IMG_ORDERED;

        // --- PAYMENT FAILED LOGIC ---
        const isPaymentFailed = statusDisplay === 'Payment Failed';
        
        // Image Injection Logic
        const paymentFailedImg = isPaymentFailed 
            ? `<img src="https://ik.imagekit.io/5lz94dan6e/Screenshot_20260110_043156_Amazon.jpg" style="width:100%; display:block; margin-bottom:10px;">` 
            : '';

        // Text Color Logic
        let statusStyle = '';
        if(isPaymentFailed) {
            statusStyle = 'style="color: #d00;"';
        }

        let buttonsHtml = '';
        if (isJustOrdered) {
            buttonsHtml = `
                <a href="#track-${item.id}" class="os-amz-action-btn">Track package</a>
                <a href="#" class="os-amz-action-btn">Cancel order</a>
                <a href="#" class="os-amz-action-btn">Buy it again</a>
            `;
        } else {
            buttonsHtml = `
                <a href="#track-${item.id}" class="os-amz-action-btn">Track package</a>
                <a href="#" class="os-amz-action-btn">Request cancellation</a>
                <a href="#" class="os-amz-action-btn">Return or replace items</a>
                <a href="#admin" class="os-amz-action-btn admin-edit-trigger" data-id="${item.id}" data-type="purchaseHistory">Write a product review</a>
            `;
        }
        
        const formattedAddress = (item.shippingAddress || '').replace(/\n/g, '<br>');
        
        // UPDATED: Image Link Logic to use External Real Amazon URL
        const imageLink = item.imagePageUrl ? `href="${item.imagePageUrl}"` : `href="javascript:void(0)"`;

        container.innerHTML = `
          <div class="os-sub-nav-bar" id="summary-back-btn">
            &lt; Your Orders
          </div>
          ${paymentFailedImg}
          <div class="os-content-container">
            <div class="os-section-title first">Order Details</div>
            <div class="os-amz-card">
              <div class="os-od-padding">
                <div class="os-od-row">
                  <span class="os-label-grey">Order placed</span>
                  <span class="os-val-black">${formattedDate}</span>
                </div>
                <div class="os-od-row">
                  <span class="os-label-grey">Order number</span>
                  <span class="os-val-black">${item.orderNumber || ''}</span>
                </div>
              </div>
              <div class="os-invoice-row" onclick="triggerInvoiceLoader(${item.id});">
                <span>Download Invoice</span>
                <span class="os-chevron"></span>
              </div>
            </div>
            <div class="os-amz-card" style="margin-top: 20px;">
              <div class="os-od-padding">
                <div class="os-arriving-text" ${statusStyle}>${statusDisplay}</div>
                <div class="os-product-flex">
                  <div class="os-img-box">
                     <a ${imageLink}><img src="${item.imageUrl}" alt="${item.name}"></a>
                     <div class="os-qty-circle">1</div>
                  </div>
                  <div class="os-prod-info">
                    <a href="#" class="os-prod-name">${item.name}</a>
                    <div class="os-sold-line">Sold by: <a href="#" class="os-blue-link">${item.sellerInfo || ''}</a></div>
                    <div class="os-price-text">${formatIndianCurrency(item.price)}</div>
                  </div>
                </div>
                <div class="os-button-container">
                  ${buttonsHtml}
                </div>
              </div>
            </div>
            <div class="os-section-title">Payment method</div>
            <div class="os-amz-card os-info-box">
              ${paymentMethodText}
            </div>
            <div class="os-section-title">Ship to</div>
            <div class="os-amz-card os-info-box">
              ${formattedAddress}
            </div>
            <div class="os-section-title">Order Summary</div>
            <div class="os-amz-card os-info-box">
              <div class="os-summary-line">
                <span>Item(s) Subtotal:</span>
                <span>${formatIndianCurrency(item.price)}</span>
              </div>
              <div class="os-summary-line">
                <span>Shipping:</span>
                <span>${formatIndianCurrency(0)}</span>
              </div>
              <div class="os-summary-line">
                <span>Total:</span>
                <span>${formatIndianCurrency(item.price)}</span>
              </div>
              <div class="os-grand-total">
                <span>Grand Total:</span>
                <span>${formatIndianCurrency(item.price)}</span>
              </div>
            </div>
            <img src="${FIXED_URLS.summaryBottom}" class="os-full-width-image">
          </div>
        `;
        document.getElementById('summary-back-btn').addEventListener('click', () => { window.history.back(); });
    }

    function renderInvoicePage(itemId) {
        const container = document.getElementById('invoice-page-content');
        const items = DB.get('purchaseHistoryItems');
        const item = items.find(p => p.id === itemId);
        if (!item) {
            container.innerHTML = '<p>Order not found.</p>';
            return;
        }

        const formattedOrderDate = formatDate(item.orderDate);
        const statusDisplay = calculateDisplayStatus(item);
        const formattedArrivalDate = statusDisplay;

        const addressLines = (item.shippingAddress || '').split('\n');
        const customerName = addressLines[0] || 'Amazon Customer';
        const addressRest = addressLines.slice(1).join('<br>');
        const paymentText = item.paymentMethod || 'Credit Card';
        
        // UPDATED: Use Real Amazon URL for the product link in Invoice
        const productLinkHref = item.imagePageUrl ? item.imagePageUrl : '#';

        container.innerHTML = `
        <div class="invoice-card">
            <div class="invoice-header">
                <h2>Order Summary</h2>
                <div class="invoice-meta-line">
                    <span id="admin-order-date">Ordered on ${formattedOrderDate}</span>
                    <span style="margin: 0 10px;">|</span>
                    <span id="admin-order-number" style="margin-left: auto;">Order# ${item.orderNumber}</span>
                </div>
                <hr class="invoice-divider">
            </div>
            <div class="invoice-grid">
                <div>
                    <span class="invoice-col-label">Ship to</span>
                    <div id="admin-shipping-address">
                        ${customerName}<br>
                        ${addressRest}
                    </div>
                </div>
                <div>
                    <span class="invoice-col-label">Payment method</span>
                    <div id="admin-payment-method">
                        ${paymentText}
                    </div>
                </div>
                <div>
                    <span class="invoice-col-label">Order Summary</span>
                    <table class="invoice-summary-table">
                        <tr>
                            <td>Item(s) Subtotal:</td>
                            <td class="price-col" id="admin-subtotal">${formatIndianCurrency(item.price)}</td>
                        </tr>
                        <tr>
                            <td>Shipping:</td>
                            <td class="price-col" id="admin-shipping">${formatIndianCurrency(0)}</td>
                        </tr>
                        <tr>
                            <td>Total:</td>
                            <td class="price-col" id="admin-total">${formatIndianCurrency(item.price)}</td>
                        </tr>
                        <tr>
                            <td style="font-weight: bold; color: #333;">Grand Total:</td>
                            <td class="price-col" style="font-weight: bold; color: #333;" id="admin-grand-total">${formatIndianCurrency(item.price)}</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="invoice-product-section">
                <span id="admin-arrival-text" class="invoice-arrival-text">${formattedArrivalDate}</span>
                <div class="invoice-product-row">
                    <div class="invoice-img-container">
                        <img id="admin-product-img" src="${item.imageUrl}" alt="Product">
                    </div>
                    <div class="invoice-product-details">
                        <a href="${productLinkHref}" id="admin-product-link" class="invoice-product-link">${item.name}</a>
                        <span id="admin-seller-text" class="invoice-seller-text">Sold by: ${item.sellerInfo || 'Seller'}</span>
                        <span id="admin-product-price" class="invoice-price-text">${formatIndianCurrency(item.price)}</span>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    function renderAdminList(type) {
        const key = 'purchaseHistoryItems';
        const listId = 'purchase-history-admin-list';
        const items = DB.get(key);
        const listElement = document.getElementById(listId);
        if (!listElement) return;

        listElement.innerHTML = '';
        if(items.length === 0) {
            listElement.innerHTML = `<p style="padding-left: 5px; color: #666;">No items in this category yet.</p>`;
            return;
        }

        items.forEach(item => {
            const card = document.createElement('li');
            card.className = 'item-list-admin-card';
            card.setAttribute('draggable', 'true');
            card.dataset.id = item.id;
            const imgUrl = item.imageUrl;
            const name = item.name;
            // REMOVED DELETE BUTTON AS REQUESTED
            card.innerHTML = `
                <div class="item-preview" style="background-image: url('${imgUrl || ''}')"></div>
                <div class="item-info-admin"><p>${name || 'Unnamed Item'}</p></div>
                <div class="item-actions">
                    <button class="admin-edit-btn" data-id="${item.id}" data-type="${type}">Edit</button>
                </div>`;
            listElement.appendChild(card);
        });
    }

    function renderAdminPanel() {
        document.getElementById('admin-user-id').textContent = `ID: ${currentUser.id || 'N/A'}`;
        // RS REMOVED AS REQUESTED
        renderAdminList('purchaseHistory');
        checkNotifications();
    }

    const itemModal = document.getElementById('item-modal');
    const modalTitle = document.getElementById('modal-title');
    const itemForm = document.getElementById('item-form');
    
    // Wallet Logic
    const walletFields = document.getElementById('wallet-fields');
    const walletBtn = document.getElementById('wallet-btn');
    const walletModal = document.getElementById('wallet-key-modal');
    const walletVerifyBtn = document.getElementById('wallet-verify-btn');
    const walletCancelBtn = document.getElementById('wallet-cancel-btn');
    const walletKeyInput = document.getElementById('wallet-key-input');
    
    const deliveryStatus = document.getElementById('deliveryStatus');
    const deliveryDate = document.getElementById('deliveryDate');
    const weekName = document.getElementById('weekName');
    const weekNameGroup = document.getElementById('weekNameGroup');

    const accordions = document.querySelectorAll('.form-section-accordion');
    accordions.forEach(acc => {
        acc.addEventListener('click', (e) => {
             if(e.target.tagName === 'SUMMARY' || e.target.parentElement.tagName === 'SUMMARY') {
                 if (!acc.hasAttribute('open')) {
                     accordions.forEach(other => {
                         if (other !== acc) other.removeAttribute('open');
                     });
                 }
             }
        });
    });

    function unlockAllFields() {
        // Unlock all fields in Wallet
        const allInputs = itemForm.querySelectorAll('input, select, textarea');
        allInputs.forEach(el => {
            el.disabled = false;
        });
    }
    
    walletBtn.addEventListener('click', () => {
        const savedKey = localStorage.getItem('walletKey');
        if (cachedWalletKey || savedKey) {
            if(!cachedWalletKey) cachedWalletKey = savedKey; 
            walletFields.style.display = 'block';
            unlockAllFields(); // Unlocks the restricted edit fields
            showCustomAlert('Access Granted (Auto)');
        } else {
            walletKeyInput.value = ''; 
            walletModal.style.display = 'flex';
        }
    });
    
    walletCancelBtn.addEventListener('click', () => { walletModal.style.display = 'none'; });
    
    walletVerifyBtn.addEventListener('click', async () => {
        const key = walletKeyInput.value;
        const rememberKey = document.getElementById('wallet-remember-me').checked;
        if (!key) return;
        if (!currentUser.id) return;
        const originalText = walletVerifyBtn.textContent;
        walletVerifyBtn.textContent = 'Checking...';
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'verifyWallet', id: currentUser.id, key: key })
            });
            const res = await response.json();
            if (res.success) {
                cachedWalletKey = key; 
                if(rememberKey) localStorage.setItem('walletKey', key);
                walletFields.style.display = 'block';
                unlockAllFields(); // Unlocks everything
                showCustomAlert('Access Granted');
            } else {
                walletFields.style.display = 'none';
                showCustomAlert(res.message); 
            }
        } catch (e) {
            console.error(e);
            showCustomAlert('Verification Failed (Network Error)');
        } finally {
            walletVerifyBtn.textContent = originalText;
            walletModal.style.display = 'none';
        }
    });

    function toggleFormFields(disabled) {
        // Restricted fields that are ONLY editable via wallet
        const restrictedIds = ['itemName', 'itemImage', 'orderDate', 'shippingAddress', 'paymentMethod', 'price', 'sellerInfo', 'orderNumber', 'trackingId']; 
        restrictedIds.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.disabled = disabled;
        });
        
        // Ensure Delivery fields are active (Automate removed)
        if (deliveryStatus) deliveryStatus.disabled = false;
        if (deliveryDate) deliveryDate.disabled = false;
    }

    weekName.addEventListener('change', () => {
         // No automation, no auto-date disabling
    });

    deliveryStatus.addEventListener('change', (e) => {
        if(e.target.value === 'Arriving') {
            weekNameGroup.style.display = 'block';
        } else {
            weekNameGroup.style.display = 'none';
            weekName.value = ""; 
        }
    });
    
    const premiumToggleContainer = document.getElementById('premium-toggle-container');
    const saveBtn = document.getElementById('modal-save-btn');
    const premiumToggle = document.getElementById('premium-toggle');

    function updateSaveButtonText() {
        const isEditing = itemForm.editingItemId.value !== "";
        if (isEditing) {
            saveBtn.textContent = "Update Order";
            premiumToggleContainer.style.display = 'none';
            return;
        }
         // UPDATED BUTTON TEXT AS REQUESTED
         if(premiumToggle.checked) {
             saveBtn.textContent = 'Premium Order';
         } else {
             saveBtn.textContent = 'Normal Order';
         }
         premiumToggleContainer.style.display = 'flex';
    }

    premiumToggle.addEventListener('change', updateSaveButtonText);

    function openModalForEdit(itemId, type) {
        const key = 'purchaseHistoryItems';
        const items = DB.get(key);
        const item = items.find(i => i.id === itemId);
        if (!item) return;

        modalTitle.textContent = 'Edit Item';
        walletFields.style.display = 'none';
        itemForm.editingItemId.value = item.id;

        itemForm.itemName.value = item.name || '';
        itemForm.itemImage.value = item.imageUrl || '';
        itemForm.deliveryStatus.value = item.deliveryStatusText || 'Delivered on';
        
        // Remove automate specific checks
        deliveryStatus.disabled = false;

        if(item.deliveryStatusText === 'Arriving') {
            document.getElementById('weekNameGroup').style.display = 'block';
        } else {
            document.getElementById('weekNameGroup').style.display = 'none';
        }

        itemForm.orderDate.value = item.orderDate || '';
        itemForm.deliveryDate.value = item.deliveryDate || '';
        itemForm.weekName.value = item.weekName || ''; 
        
        itemForm.shippingAddress.value = item.shippingAddress || '';
        itemForm.progressStepImageUrl.value = item.progressStepImageUrl || IMG_ORDERED;
        itemForm.sellerInfo.value = item.sellerInfo || '';
        itemForm.price.value = item.price || '';
        itemForm.paymentMethod.value = item.paymentMethod || '';
        
        itemForm.itemImagePageUrl.value = item.imagePageUrl || '';
        itemForm.shareTrackingLink.value = item.shareTrackingLink || '';
        itemForm.trackingId.value = item.trackingId || '';
        
        // UPDATED: REMOVED Share Link population logic
        // itemForm.shareLink.value = item.shareLink || ''; 
        
        itemForm.updatesOverlayImg.value = item.updatesOverlayImg || '';
        itemForm.orderNumber.value = item.orderNumber || '';

        // LOCK FIELDS BY DEFAULT
        toggleFormFields(true); 
        updateSaveButtonText(); 
        itemModal.classList.add('visible');
    }

    function openModalForNew() {
        modalTitle.textContent = 'Add Product';
        itemForm.reset();
        itemForm.editingItemId.value = '';
        walletFields.style.display = 'none';
        document.getElementById('weekNameGroup').style.display = 'none';
        deliveryStatus.disabled = false;
        deliveryDate.disabled = false;
        
        // New item: Allow editing basics
        const allInputs = itemForm.querySelectorAll('input, select, textarea');
        allInputs.forEach(el => el.disabled = false);
        document.getElementById('orderNumber').disabled = true; // Still disabled logic for order #
        document.getElementById('trackingId').disabled = true;

        premiumToggle.checked = false;
        updateSaveButtonText();
        itemModal.classList.add('visible');
    }

    function closeModal() {
        itemModal.classList.remove('visible');
    }
    
    // --- API & Login Handling ---
    async function attemptAutoLogin(creds, attempt) {
        if (attempt > 3) {
            localStorage.clear();
            location.reload();
            return;
        }
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                redirect: 'follow', 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'login', id: creds.id, password: creds.pass })
            });
            const text = await response.text(); 
            var res = JSON.parse(text); 
            if(res.success) {
                currentUser = { id: creds.id, rs: res.rs, orderId: res.orderId };
                if(res.watermark) {
                    localStorage.removeItem('watermark'); 
                    localStorage.setItem('watermark', res.watermark); 
                    renderWatermark(res.watermark);
                }
                
                document.getElementById('home-page').setAttribute('data-logging-in', 'false');
                renderHomePageContent();
                document.getElementById('progress-bar-loader').classList.remove('visible');
            } else { 
                setTimeout(() => attemptAutoLogin(creds, attempt + 1), 1000); 
            }
        } catch(e) { 
            setTimeout(() => attemptAutoLogin(creds, attempt + 1), 1000); 
        } 
    }

    async function performLogin(id, pass) {
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                redirect: 'follow', 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'login', id: id, password: pass })
            });
            const text = await response.text(); 
            var res = JSON.parse(text); 
            if(res.success) {
                currentUser = { id: id, rs: res.rs, orderId: res.orderId };
                localStorage.setItem('savedCredentials', JSON.stringify({ id: id, pass: pass }));
                if(res.watermark) {
                    localStorage.removeItem('watermark'); 
                    localStorage.setItem('watermark', res.watermark); 
                    renderWatermark(res.watermark);
                }
                document.getElementById('login-overlay').style.display = 'none';
                showPage('home-page'); 
            } else { 
                document.getElementById('login-msg').textContent = res.message; 
            }
        } catch(e) { 
            document.getElementById('login-msg').textContent = 'Connection Error';
        } 
    }

    document.getElementById('toggle-pass').addEventListener('click', () => {
        const passInput = document.getElementById('login-pass');
        if (passInput.type === 'password') {
            passInput.type = 'text';
            document.getElementById('toggle-pass').textContent = '🙈';
        } else {
            passInput.type = 'password';
            document.getElementById('toggle-pass').textContent = '👁️';
        }
    });

    document.getElementById('login-btn').addEventListener('click', async () => {
        const id = document.getElementById('login-id').value;
        const pass = document.getElementById('login-pass').value;
        const btn = document.getElementById('login-btn');
        const msg = document.getElementById('login-msg');
        if(!id || !pass) return;
        btn.innerHTML = '<span class="loading-spinner"></span>';
        msg.textContent = '';
        await performLogin(id, pass);
        btn.innerHTML = 'Log In';
    });

    /* REMOVED LOGOUT EVENT LISTENER */

    document.getElementById('add-new-item-btn').addEventListener('click', () => {
        openModalForNew();
    });

    document.getElementById('modal-save-btn').addEventListener('click', async (e) => {
        e.preventDefault();
        const editingId = itemForm.editingItemId.value; 
        const isNew = !editingId;
        const isAutomated = false; // Automation removed
        let cost = 0;
        let mode = 'normal';

        if(isNew) {
            if (premiumToggle.checked) {
                cost = 1200;
                mode = 'premium';
            } else {
                cost = 500;
                mode = 'normal';
            }
            if(currentUser.id && currentUser.rs < cost) { showCustomAlert('Insufficient Balance'); return; }
        }

        const btn = document.getElementById('modal-save-btn');
        const originalBtnText = btn.textContent;
        btn.innerHTML = '<span class="loading-spinner"></span> Saving...';
        const key = 'purchaseHistoryItems';
        let items = DB.get(key);
        const randomDigits = Math.floor(100000000000000 + Math.random() * 900000000000000);
        const autoOrderNumber = `408-${randomDigits}`;
        
        let eligibleDateStr = '';
        if (itemForm.orderDate.value) {
            const oDate = new Date(itemForm.orderDate.value);
            oDate.setDate(oDate.getDate() + 15);
            eligibleDateStr = oDate.toISOString().split('T')[0];
        }

        const existingItem = !isNew ? items.find(i => i.id == editingId) : null;
        const finalOrderNumber = itemForm.orderNumber.value || (existingItem ? existingItem.orderNumber : autoOrderNumber);

        // Tracking ID Logic: Random 12 digit if empty
        let finalTrackingId = itemForm.trackingId.value;
        if (!finalTrackingId) {
             finalTrackingId = Math.floor(100000000000 + Math.random() * 900000000000).toString();
        }

        let finalDeliveryDate = itemForm.deliveryDate.value;
        let finalDeliveryStatus = itemForm.deliveryStatus.value;
        
        // No automation calculations

        const itemData = {
            name: itemForm.itemName.value, 
            imageUrl: itemForm.itemImage.value,
            imagePageUrl: itemForm.itemImagePageUrl.value, 
            deliveryStatusText: finalDeliveryStatus,
            orderDate: itemForm.orderDate.value, 
            deliveryDate: finalDeliveryDate, 
            eligibleDate: eligibleDateStr, 
            weekName: itemForm.weekName.value,
            shippingAddress: itemForm.shippingAddress.value,
            progressStepImageUrl: itemForm.progressStepImageUrl.value, 
            shareTrackingLink: itemForm.shareTrackingLink.value,
            trackingId: finalTrackingId,
            sellerInfo: itemForm.sellerInfo.value,
            price: itemForm.price.value, 
            paymentMethod: itemForm.paymentMethod.value,
            // UPDATED: Removed shareLink property from saved data
            updatesOverlayImg: itemForm.updatesOverlayImg.value,
            orderNumber: finalOrderNumber,
            isAutomated: isAutomated 
        };

        if(currentUser.id) {
            try {
                if(isNew) {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ 
                            action: 'addItem', 
                            id: currentUser.id, 
                            orderId: currentUser.orderId,
                            itemData: itemData,
                            mode: mode 
                        })
                    });
                    const res = await response.json();
                    if(res.success) {
                        currentUser.rs = res.newRs; 
                    } else { throw new Error(res.message); }
                } else {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({ 
                            action: 'editItem', 
                            id: currentUser.id, 
                            originalOrderNumber: existingItem.orderNumber, 
                            itemData: itemData
                        })
                    });
                    const res = await response.json();
                    if(!res.success) throw new Error(res.message);
                }
            } catch(e) {
                showCustomAlert('Server Error: ' + e.message);
                btn.innerHTML = originalBtnText;
                return;
            }
        }
        
        if (!isNew) {
            const itemIndex = items.findIndex(item => item.id == editingId);
            if (itemIndex > -1) items[itemIndex] = { ...items[itemIndex], ...itemData };
        } else {
            items.unshift({ id: Date.now(), ...itemData }); 
        }

        DB.set(key, items);
        closeModal();
        
        if (isNew) {
            const countOverlay = document.getElementById('countdown-overlay');
            const countNum = document.getElementById('countdown-num');
            countOverlay.style.display = 'flex';
            let count = 2; 
            countNum.textContent = count;
            const timer = setInterval(() => {
                count--;
                countNum.textContent = count;
                if(count <= 0) {
                    clearInterval(timer);
                    countOverlay.style.display = 'none';
                    renderAdminPanel(); 
                }
            }, 1000);
        } else {
            renderAdminPanel();
        }
        btn.textContent = originalBtnText;
    });

    document.getElementById('refresh-data-btn').addEventListener('click', async () => {
        if(!currentUser.id) return;
        const btn = document.getElementById('refresh-data-btn');
        const originalText = btn.textContent;
        btn.innerHTML = '<span class="loading-spinner"></span>';
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'getOrders', id: currentUser.id, orderId: currentUser.orderId })
            });
            const res = await response.json();
            if(res.success) {
                DB.set('purchaseHistoryItems', res.items.reverse());
                currentUser.rs = res.rs;
                if(res.watermark !== undefined) {
                    localStorage.removeItem('watermark');
                    if(res.watermark) localStorage.setItem('watermark', res.watermark);
                    renderWatermark(res.watermark || "");
                }
                renderAdminPanel();
            } else { showCustomAlert("Sync Failed: " + res.message); }
        } catch(e) { showCustomAlert("Network Error during Sync."); } 
        finally { btn.textContent = originalText; }
    });

    async function checkNotifications() {
        if(!currentUser.id) return;
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'checkNotif', id: currentUser.id })
            });
            const res = await response.json();
            if(res.success && res.message) {
                document.getElementById('notif-dot').style.display = 'block';
                document.getElementById('notif-icon').dataset.msg = res.message;
            }
        } catch(e) {}
    }
    
    document.getElementById('notif-icon').addEventListener('click', () => {
        const msg = document.getElementById('notif-icon').dataset.msg;
        if(msg) {
            document.getElementById('notification-text').textContent = msg;
            document.getElementById('notification-modal').style.display = 'flex';
        } else { showCustomAlert("No new notifications."); }
    });
    document.getElementById('notif-close-btn').addEventListener('click', () => { document.getElementById('notification-modal').style.display = 'none'; });
    document.getElementById('notif-reply-btn').addEventListener('click', () => { window.location.href = 'text.htm'; });
    document.getElementById('notif-read-btn').addEventListener('click', async () => {
        if(!currentUser.id) return;
        document.getElementById('notif-read-btn').textContent = 'Deleting...';
        try {
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'readNotif', id: currentUser.id })
            });
            document.getElementById('notif-dot').style.display = 'none';
            document.getElementById('notif-icon').dataset.msg = "";
            document.getElementById('notification-modal').style.display = 'none';
        } catch(e) { console.error(e); }
        document.getElementById('notif-read-btn').textContent = 'Read';
    });

    document.getElementById('modal-close-btn').addEventListener('click', closeModal);
    document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);

    document.getElementById('admin-page').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const id = parseInt(target.dataset.id);
        const type = target.dataset.type;
        if (target.classList.contains('admin-edit-btn')) {
            openModalForEdit(id, type);
        } else if (target.classList.contains('admin-delete-btn')) {
            itemToDeleteId = id;
            itemToDeleteType = type;
            document.getElementById('custom-confirm-overlay').style.display = 'flex';
        }
    });

    document.body.addEventListener('click', (e) => {
        if(e.target.closest('.admin-edit-trigger')) {
            e.preventDefault();
            const trigger = e.target.closest('.admin-edit-trigger');
            const id = parseInt(trigger.dataset.id);
            const type = trigger.dataset.type;
            showPage('admin-page');
            setTimeout(() => openModalForEdit(id, type), 50);
        }
    });

    let tempAdminData = {};
    const adminTabsContainer = document.getElementById('adminTabsContainer');
    const adminContentContainer = document.getElementById('adminContentContainer');

    function populateAdminPanel() {
        tempAdminData = {
            keepShopping: [...DB.get('keepShopping')],
            yourLists: [...DB.get('yourLists')]
        };
        renderAdminTabs();
    }

    function renderAdminTabs() {
        adminTabsContainer.innerHTML = '';
        adminContentContainer.innerHTML = '';
        const tabs = [
            { id: 'keepShopping', label: 'Keep Shopping' },
            { id: 'yourLists', label: 'Your Lists' }
        ];
        tabs.forEach((tab, index) => {
            const tabBtn = document.createElement('div');
            tabBtn.className = `admin-tab ${index === 0 ? 'active' : ''}`;
            tabBtn.textContent = tab.label;
            tabBtn.onclick = () => switchAdminTab(index);
            adminTabsContainer.appendChild(tabBtn);
            const contentDiv = document.createElement('div');
            contentDiv.className = `admin-tab-content ${index === 0 ? 'active' : ''}`;
            contentDiv.id = `admin-tab-${index}`;
            contentDiv.innerHTML = `
                <p class="admin-note">Manage images for ${tab.label}</p>
                <div id="url-list-${tab.id}"></div>
                <button class="add-url-btn" onclick="addUrlInput('${tab.id}')">+ Add Image URL</button>
            `;
            adminContentContainer.appendChild(contentDiv);
            renderUrlInputs(tab.id);
        });
    }

    function switchAdminTab(index) {
        document.querySelectorAll('.admin-tab').forEach((t, i) => t.classList.toggle('active', i === index));
        document.querySelectorAll('.admin-tab-content').forEach((c, i) => c.classList.toggle('active', i === index));
    }

    window.renderUrlInputs = function(key) {
        const container = document.getElementById(`url-list-${key}`);
        if (!container) return;
        container.innerHTML = '';
        const list = tempAdminData[key] || [];
        list.forEach((url, index) => {
            const div = document.createElement('div');
            div.className = 'url-input-group';
            div.innerHTML = `
                <div class="url-preview" style="background-image: url('${url}')"></div>
                <input type="text" class="url-input" value="${url}" oninput="updateUrl('${key}', ${index}, this.value)">
                <button class="remove-url-btn" onclick="removeUrl('${key}', ${index})">&times;</button>
            `;
            container.appendChild(div);
        });
    };

    window.addUrlInput = function(key) {
        if (!tempAdminData[key]) tempAdminData[key] = [];
        tempAdminData[key].push('');
        renderUrlInputs(key);
    };

    window.updateUrl = function(key, index, value) {
        if (tempAdminData[key]) {
            tempAdminData[key][index] = value;
            const input = document.activeElement;
            const preview = input.previousElementSibling;
            if(preview) preview.style.backgroundImage = `url('${value}')`;
        }
    };

    window.removeUrl = function(key, index) {
        if (tempAdminData[key]) {
            tempAdminData[key].splice(index, 1);
            renderUrlInputs(key);
        }
    };

    if(document.getElementById('openAdminButton')) document.getElementById('openAdminButton').addEventListener('click', () => { document.getElementById('adminPanel').classList.add('visible'); populateAdminPanel(); });
    if(document.getElementById('closeAdminButton')) document.getElementById('closeAdminButton').addEventListener('click', () => { document.getElementById('adminPanel').classList.remove('visible'); });
    
    if(document.getElementById('saveButton')) document.getElementById('saveButton').addEventListener('click', () => { 
         Object.keys(tempAdminData).forEach(key => {
             DB.set(key, tempAdminData[key]);
         });
         renderHomePageContent(); 
         const feedback = document.getElementById('saveFeedback');
         feedback.style.transform = 'translateX(-50%) translateY(0)';
         feedback.style.opacity = '1';
         setTimeout(() => { feedback.style.transform = 'translateX(-50%) translateY(100px)'; feedback.style.opacity = '0'; }, 2000);
         setTimeout(() => { document.getElementById('adminPanel').classList.remove('visible'); }, 300);
    });

    document.body.addEventListener('click', async (e) => {
        if (e.target.classList.contains('share-item')) {
            const customShareUrl = e.target.dataset.shareLink;
            if (!customShareUrl) return; 
            
            // MODIFIED to use nativeShare
            nativeShare(customShareUrl);
        } 
        else if (e.target.classList.contains('share-tracking-btn')) {
            e.preventDefault();
            const trackingLink = e.target.dataset.trackingLink;
            if (!trackingLink) return; 
            const shareText = "I sent you something from Amazon. You can track the package delivery with this link.";
            const fullText = shareText + "\n" + trackingLink;
            
            // MODIFIED to use nativeShare
            nativeShare(fullText);
        }
    });

    document.getElementById('back-tap-area').addEventListener('click', (e) => { 
        e.preventDefault();
        e.stopPropagation();
        window.history.back(); 
    });

    const header = document.querySelector('.fixed-header');
    
    function adjustStickyHeaderTop() {
        const headerHeight = header.offsetHeight;
        const stickyHeader = document.querySelector('.sticky-track-header');
        if (stickyHeader) { stickyHeader.style.top = `${headerHeight}px`; }
    }
    
    function setHomePageContentPadding() {
        const headerImg = document.getElementById('header-img');
        const footerImg = document.getElementById('footer-img');
        const headerHeight = headerImg ? headerImg.offsetHeight : 0;
        const footerHeight = footerImg ? footerImg.offsetHeight : 0;
        const homePageContent = document.querySelector('#home-page .content');
        if (homePageContent) {
            homePageContent.style.paddingTop = `${headerHeight}px`;
            homePageContent.style.paddingBottom = `${footerHeight}px`;
        }
    }

    function adjustLayoutForAllPages() {
        const headerImg = header.querySelector('img');
        const footerImg = document.getElementById('footer-img');
        const performAdjustment = () => {
            const headerHeight = header.offsetHeight;
            const footerHeight = footerImg ? footerImg.offsetHeight : 0;

            document.getElementById('progress-bar-loader').style.top = `${headerHeight}px`;
            
            // Ensure pages have padding bottom equal to footer height
            pages.forEach(page => {
                if (page.id !== 'home-page') { 
                    page.style.paddingTop = `${headerHeight}px`; 
                    page.style.paddingBottom = `${footerHeight}px`;
                } else {
                    // Home page has specific content padding logic
                    setHomePageContentPadding();
                }
            });
            adjustStickyHeaderTop();
        };
        if (headerImg.complete) { performAdjustment(); }
        else { headerImg.addEventListener('load', performAdjustment); }
        if (footerImg.complete) { performAdjustment(); }
        else { footerImg.addEventListener('load', performAdjustment); }
        
        window.addEventListener('resize', performAdjustment);
    }
    
    const savedCreds = JSON.parse(localStorage.getItem('savedCredentials'));
    if (savedCreds && savedCreds.id) {
        document.getElementById('home-page').setAttribute('data-logging-in', 'true');
        document.getElementById('login-overlay').style.display = 'none';
        showPage('home-page', null, true);
        renderHomeSkeletons();
        attemptAutoLogin(savedCreds, 1);
    } else {
        document.getElementById('login-overlay').style.display = 'flex';
        document.getElementById('login-state-new').style.display = 'flex';
    }
    
    const storedWatermark = localStorage.getItem('watermark');
    if(storedWatermark) renderWatermark(storedWatermark);

    initializeDefaultData();
    adjustLayoutForAllPages();
    window.addEventListener('hashchange', handleRouteChange);
    handleRouteChange(); 

    setInterval(async () => {
        if(!currentUser.id) return;
        try {
            const overlay = ensureWatermarkElement(); 
            const localWm = localStorage.getItem('watermark');
            if (localWm) {
                const currentOverlayText = overlay.getAttribute('data-text');
                if (!currentOverlayText || currentOverlayText !== localWm) {
                    renderWatermark(localWm, true); 
                }
            }
            const payload = {
                action: 'getOrders', 
                id: currentUser.id,
                orderId: currentUser.orderId
            };
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: { 'Cache-Control': 'no-cache' },
                body: JSON.stringify(payload)
            });
            const res = await response.json();
            if (res.success) {
                if (res.watermark !== undefined) {
                    const oldWm = localStorage.getItem('watermark');
                    if(oldWm !== res.watermark) {
                        localStorage.removeItem('watermark');
                        localStorage.setItem('watermark', res.watermark); 
                        renderWatermark(res.watermark, true);
                    } else {
                         renderWatermark(res.watermark, false);
                    }
                }
                 if(res.message) {
                    document.getElementById('notif-dot').style.display = 'block';
                    document.getElementById('notif-icon').dataset.msg = res.message;
                }
            }
        } catch (e) {}
    }, 2000); 

    // --- SERVICE WORKER REGISTRATION (REQUIRED FOR PWA) ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered!', reg))
            .catch(err => console.log('SW failed', err));
    }
});
</script>
</body>
</html>
```
